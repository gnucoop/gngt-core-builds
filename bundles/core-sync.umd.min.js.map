{"version":3,"file":"core-sync.umd.min.js","sources":["../../node_modules/tslib/tslib.es6.js","../../src/core/sync/registered-models.ts","../../src/core/sync/sync-options.ts","../../src/core/sync/sync-service.ts","../../src/core/sync/sync-utils.ts","../../src/core/sync/offline-interceptor.ts","../../src/core/sync/sync-module.ts"],"sourcesContent":["/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)\r\n            t[p[i]] = s[p[i]];\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator], i = 0;\r\n    if (m) return m.call(o);\r\n    return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {RegisteredModel} from './registered-model';\n\nexport const SYNC_REGISTERED_MODELS: RegisteredModel[] = [];\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {InjectionToken} from '@angular/core';\n\nexport interface SyncOptions {\n  baseUrl: string;\n  changesPath?: string;\n  docsPath?: string;\n  localDatabaseName: string;\n  syncInterval?: number;\n  changesBatchSize?: number;\n}\n\nexport const SYNC_OPTIONS = new InjectionToken<SyncOptions>('SYNC_OPTIONS');\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {HttpClient, HttpErrorResponse} from '@angular/common/http';\nimport {Inject, Injectable} from '@angular/core';\n\nimport {\n  BehaviorSubject, from, Observable, of as obsOf, Subscription, throwError, timer, zip\n} from 'rxjs';\nimport {\n  catchError, concatMap, delayWhen, exhaustMap, filter, map, mapTo, switchMap, take, tap, toArray\n} from 'rxjs/operators';\n\nimport * as PouchDB from 'pouchdb';\nimport * as PouchDBDebug from 'pouchdb-debug';\nimport * as PouchDBFind from 'pouchdb-find';\n\nimport {ModelGetParams, ModelListParams, ModelQueryParams, ModelSort} from '@gngt/core/common';\nimport {LocalDoc} from './local-doc';\nimport {LocalSyncEntry} from './local-sync-entry';\nimport {LocalSyncNumber} from './local-sync-number';\nimport {SyncCheckpoint} from './sync-checkpoint';\nimport {SyncEntry} from './sync-entry';\nimport {SYNC_OPTIONS, SyncOptions} from './sync-options';\nimport {SyncStatus} from './sync-status';\nimport {registerSyncModel} from './sync-utils';\nimport {UpwardChange} from './upward-change';\nimport {UpwardChangeResult} from './upward-change-result';\n\ntype DatabaseContent = LocalDoc<any> | LocalSyncEntry | LocalSyncNumber | SyncCheckpoint;\n\nconst pouchDBStatic: PouchDB.Static = (<any>PouchDB).default || PouchDB;\nconst pouchDBFindPlugin: PouchDB.Plugin = (<any>PouchDBFind).default || PouchDBFind;\n\n@Injectable()\nexport class SyncService {\n  private _status: BehaviorSubject<SyncStatus>\n    = new BehaviorSubject<SyncStatus>({status: 'initializing'});\n  readonly status: Observable<SyncStatus> = this._status.asObservable();\n\n  private _timerSub: Subscription = Subscription.EMPTY;\n  private _syncing = false;\n  private _database: PouchDB.Database<DatabaseContent>;\n  private readonly _remoteCheckpointKey = 'gngt_remote_sync_checkpoint';\n  private readonly _localCheckpointKey = 'gngt_local_sync_checkpoint';\n  private readonly _localSyncNumber = 'gngt_local_sync_number';\n  private readonly _localSyncEntryPrefix = 'gngt_local_sync_entry_';\n  private readonly _syncUrl: string;\n  private readonly _changesUrl: string;\n  private readonly _relationalModelIdx: PouchDB.Find.CreateIndexOptions = {\n    index: {name: 'relational_model_idx', fields: ['table_name', 'object_id']}\n  };\n  private readonly _databaseInit: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\n  private readonly _databaseIsInit: Observable<boolean>;\n\n  constructor(@Inject(SYNC_OPTIONS) private _opts: SyncOptions, private _httpClient: HttpClient) {\n    if (this._opts.syncInterval == null) { this._opts.syncInterval = 300000; }\n    if (this._opts.changesBatchSize == null) { this._opts.changesBatchSize = 50; }\n\n    this._syncUrl = `${this._opts.baseUrl}${this._opts.changesPath || 'changes'}`;\n    this._changesUrl = `${this._opts.baseUrl}${this._opts.docsPath || 'docs'}`;\n    this._initLocalDatabase();\n    this._databaseIsInit = this._databaseInit.pipe(filter(i => i));\n  }\n\n  registerSyncModel(endPoint: string, tableName: string): void {\n    registerSyncModel(endPoint, tableName);\n  }\n\n  start(immediate = true): void {\n    if (this._syncing) { return; }\n    this._syncing = true;\n    this._timerSub = timer(immediate ? 0 : this._opts.syncInterval, this._opts.syncInterval).pipe(\n      delayWhen(_ => this._databaseIsInit),\n    ).subscribe(_ => this._checkSync());\n  }\n\n  stop(): void {\n    if (!this._syncing) { return; }\n    this._timerSub.unsubscribe();\n    this._syncing = false;\n  }\n\n  get(tableName: string, params: ModelGetParams): Observable<any> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => this._relationalModelIdxObs()),\n      exhaustMap(_ => from(db.find(this._modelGetFindRequest(tableName, params)))),\n      take(1),\n      switchMap(res => {\n        if (res.docs.length === 1) {\n          let obj = this._subObject(res.docs[0].object, params.fields);\n          if (params.joins != null) {\n            return zip(...params.joins.map(join =>\n              from(db.find(\n                this._modelGetFindRequest(join.model, {id: obj[join.property], fields: join.fields})\n              )).pipe(\n                take(1),\n                map(related => related.docs.length === 1 ? related.docs[0].object : null),\n                map(related => ({join, related})),\n              )\n            )).pipe(\n              map(joins => {\n                joins.forEach(joinEntry => {\n                  obj[joinEntry.join.property] = joinEntry.related;\n                });\n                return obj;\n              })\n            );\n          }\n          return obsOf(obj);\n        }\n        return throwError('not_found');\n      }),\n      take(1),\n    );\n  }\n\n  list(tableName: string, params: ModelListParams): Observable<any[]> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => this._relationalModelIdxObs({tableName, sort: params.sort})),\n      exhaustMap(idx => from(db.find(this._modelListFindRequest(tableName, params, idx)))),\n      take(1),\n      switchMap(res => {\n        if (params.joins != null) {\n          const joinTables: {[table: string]: number[]} = params.joins.reduce((prev, cur) => {\n            prev[cur.model] = res.docs.map(d => d.object[cur.property]);\n            return prev;\n          }, {} as {[table: string]: number[]});\n          return zip(...params.joins.map(join => {\n              const req = this._modelListFindRequest(join.model, {fields: join.fields});\n              req.selector['object_id'] = {'$in': joinTables[join.model]};\n              return from(db.find(req)).pipe(\n                take(1),\n                map(related => ({join, related: related.docs})),\n              );\n          })).pipe(\n            map(joins => {\n              return res.docs.map(doc => {\n                const obj = doc.object;\n                joins.forEach(joinEntry => {\n                  const prop = joinEntry.join.property;\n                  const rel = joinEntry.related.find(r => r.object_id === obj[prop]);\n                  obj[prop] = rel != null ? rel.object : null;\n                });\n                return this._subObject(obj, params.fields);\n              });\n            }),\n          );\n        }\n        return obsOf(res.docs.map(d => this._subObject(d.object, params.fields)));\n      }),\n      take(1),\n    );\n  }\n\n  create(tableName: string, object: any): Observable<any> {\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => this._nextObjectId(tableName)),\n      take(1),\n      exhaustMap(id => {\n        object = {id, ...object};\n        const localDoc = {table_name: tableName, object_id: id};\n        return from(this._database.post({...localDoc, object})).pipe(\n          exhaustMap(doc => this._createLocalSyncEntry(\n            {doc_id: doc.id, entry_type: 'insert', ...localDoc}\n          ).pipe(\n            map(() => object),\n          )),\n        );\n      }),\n      take(1),\n    );\n  }\n\n  update(tableName: string, id: number, object: any): Observable<any> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => from(db.find(this._modelGetFindRequest(tableName, {id})))),\n      take(1),\n      exhaustMap(res => {\n        if (res.docs.length !== 1) {\n          return throwError('not_found');\n        }\n        const localDoc = {...res.docs[0], object};\n        return from(db.post(localDoc)).pipe(\n          map(r => ({res: r, localDoc})),\n        );\n      }),\n      take(1),\n      exhaustMap(({res, localDoc}) => {\n        const syncEntry: Partial<LocalSyncEntry> = {\n          doc_id: res.id,\n          table_name: tableName,\n          object_id: localDoc.object_id,\n          entry_type: 'update'\n        };\n        return this._createLocalSyncEntry(syncEntry).pipe(\n          map(() => localDoc.object),\n        );\n      }),\n      take(1),\n    );\n  }\n\n  delete(tableName: string, id: number): Observable<any> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => from(db.find(this._modelGetFindRequest(tableName, {id})))),\n      take(1),\n      exhaustMap(res => {\n        if (res.docs.length !== 1) {\n          return throwError('not_found');\n        }\n        const localDoc = res.docs[0];\n        return from(db.remove(localDoc)).pipe(\n          map(r => ({res: r, localDoc})),\n        );\n      }),\n      take(1),\n      exhaustMap(({res, localDoc}) => {\n        const syncEntry: Partial<LocalSyncEntry> = {\n          doc_id: res.id,\n          table_name: tableName,\n          object_id: localDoc.object_id,\n          entry_type: 'delete'\n        };\n        return this._createLocalSyncEntry(syncEntry).pipe(\n          map(() => localDoc.object),\n        );\n      }),\n      take(1),\n    );\n  }\n\n  deleteAll(tableName: string, ids: number[]): Observable<any[]> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => from(db.find(this._modelBulkIdsFindRequest(tableName, ids)))),\n      take(1),\n      concatMap(res => {\n        if (res.docs.length !== 1) {\n          return throwError('not_found');\n        }\n        return from(res.docs);\n      }),\n      concatMap(localDoc => {\n        return from(db.remove(localDoc)).pipe(\n          map(res => ({res, localDoc})),\n        );\n      }),\n      concatMap(({res, localDoc}) => {\n        const syncEntry: Partial<LocalSyncEntry> = {\n          doc_id: res.id,\n          table_name: tableName,\n          object_id: localDoc.object_id,\n          entry_type: 'delete'\n        };\n        return this._createLocalSyncEntry(syncEntry).pipe(\n          map(() => localDoc.object),\n        );\n      }),\n      take(ids.length),\n      toArray(),\n    );\n  }\n\n  query(tableName: string, params: ModelQueryParams): Observable<any[]> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => this._relationalModelIdxObs({tableName, sort: params.sort})),\n      take(1),\n      exhaustMap(idx => from(db.find(this._modelQueryFindRequest(tableName, params, idx)))),\n      take(1),\n      switchMap(res => {\n        if (params.joins != null) {\n          const joinTables: {[table: string]: number[]} = params.joins.reduce((prev, cur) => {\n            prev[cur.model] = res.docs.map(d => d.object[cur.property]);\n            return prev;\n          }, {} as {[table: string]: number[]});\n          return zip(...params.joins.map(join => {\n              const req = this._modelListFindRequest(join.model, {fields: join.fields});\n              req.selector['object_id'] = {'$in': joinTables[join.model]};\n              return from(db.find(req)).pipe(\n                take(1),\n                map(related => ({join, related: related.docs})),\n              );\n          })).pipe(\n            map(joins => {\n              return res.docs.map(doc => {\n                const obj = doc.object;\n                joins.forEach(joinEntry => {\n                  const prop = joinEntry.join.property;\n                  const rel = joinEntry.related.find(r => r.object_id === obj[prop]);\n                  obj[prop] = rel != null ? rel.object : null;\n                });\n                return this._subObject(obj, params.fields);\n              });\n            }),\n          );\n        }\n        return obsOf(res.docs.map(d => this._subObject(d.object, params.fields)));\n      }),\n      take(1),\n    );\n  }\n\n  private _getLocalDocsDb(): PouchDB.Database<LocalDoc<any>> {\n    return this._database as PouchDB.Database<LocalDoc<any>>;\n  }\n\n  private _getLocalSyncDb(): PouchDB.Database<LocalSyncEntry> {\n    return this._database as PouchDB.Database<LocalSyncEntry>;\n  }\n\n  private _getLocalSyncNumberDb(): PouchDB.Database<LocalSyncNumber> {\n    return this._database as PouchDB.Database<LocalSyncNumber>;\n  }\n\n  private _getSyncCheckpointDb(): PouchDB.Database<SyncCheckpoint> {\n    return this._database as PouchDB.Database<SyncCheckpoint>;\n  }\n\n  private _createLocalSyncEntry(syncEntry: Partial<LocalSyncEntry>): Observable<number> {\n    return this._getNextLocalSyncNumber().pipe(\n      exhaustMap(syncNumber => {\n        syncEntry._id = `_local/${this._localSyncEntryPrefix}${syncNumber}`;\n        syncEntry.sequence = syncNumber;\n        return from(this._database.put<LocalSyncEntry>(syncEntry as LocalSyncEntry)).pipe(\n          take(1),\n          exhaustMap(_ => this._setLocalSyncNumber(syncNumber)),\n          take(1),\n        );\n      }),\n    );\n  }\n\n  private _setLocalSyncNumber(syncNumber: number): Observable<number> {\n    const db = this._getLocalSyncNumberDb();\n    const id = `_local/${this._localSyncNumber}`;\n    return from(db.get(id)).pipe(\n      take(1),\n      catchError(_ => obsOf({_id: id, number: 0} as LocalSyncNumber)),\n      exhaustMap(doc => from(db.post({...doc, number: syncNumber})).pipe(take(1))),\n      map(_ => syncNumber),\n    );\n  }\n\n  private _getNextLocalSyncNumber(): Observable<number> {\n    const db = this._getLocalSyncNumberDb();\n    return from(db.get(`_local/${this._localSyncNumber}`)\n    ).pipe(\n      take(1),\n      map(doc => doc.number + 1),\n      catchError(_ => obsOf(1)),\n    );\n  }\n\n  private _nextObjectId(tableName: string): Observable<number> {\n    const sort = {object_id: 'desc'} as ModelSort;\n    const db = this._getLocalDocsDb();\n    return this._relationalModelIdxObs({tableName, sort}).pipe(\n      exhaustMap(idx => from(db.find(\n        this._modelListFindRequest(tableName, {sort}, idx)\n      )).pipe(take(1))),\n      map(res => res.docs.length > 0 ? res.docs[0].object_id + 1 : 1),\n    );\n  }\n\n  private _relationalModelIdxObs(\n    idxDef?: {tableName: string, sort?: ModelSort}\n  ): Observable<PouchDB.Find.CreateIndexResponse<LocalDoc<any>>> {\n    if (idxDef != null && idxDef.sort != null) {\n      let {dir, fields} = this._normalizeSortParam(idxDef.sort);\n      fields = [{table_name: dir}, ...fields];\n      if (fields.length > 0) {\n        return from(this._database.createIndex({\n          index: {\n            name: this._generateIndexName(idxDef.tableName, fields),\n            fields: fields as any\n          }\n        }));\n      }\n    }\n    return from(this._database.createIndex(this._relationalModelIdx)).pipe(take(1));\n  }\n\n  private _generateIndexName(tableName: string, fields: ModelSort[]): string {\n    return `idx___${tableName}___${fields.map(f => {\n      const key = Object.keys(f)[0];\n      return `${key}__${f[key]}`;\n    }).join('___')}`;\n  }\n\n  private _subObject(obj: any, fields?: string[]): any {\n    if (obj == null || fields == null) { return obj; }\n    obj = obj || {};\n    const subObj: any = {};\n    (fields || []).forEach(f => subObj[f] = obj[f]);\n    return subObj;\n  }\n\n  private _checkSync(): void {\n    this._checkUpwardSync();\n  }\n\n  private _checkUpwardSync(): void {\n    zip(this._getLastLocalCheckpoint(), this._getNextLocalSyncNumber()).pipe(\n      exhaustMap(([checkpoint, syncNumber]) => {\n        const localSyncDb = this._getLocalSyncDb();\n        const gets: Observable<LocalSyncEntry>[] = [];\n        const firstId = checkpoint + 1;\n        const lastId = Math.min(firstId + this._opts.changesBatchSize! - 1, syncNumber - 1);\n        if (lastId <= checkpoint) {\n          return obsOf(false);\n        }\n\n        const hasNext = lastId < syncNumber - 1;\n\n        this.stop();\n\n        for (let i = firstId ; i <= lastId ; i++) {\n          gets.push(from(localSyncDb.get(`_local/${this._localSyncEntryPrefix}${i}`)));\n        }\n        return zip(...gets).pipe(\n          exhaustMap(entries => {\n            const localDocsDb = this._getLocalDocsDb();\n            const opts = {keys: entries.map(e => e.doc_id), include_docs: true};\n            return from(localDocsDb.allDocs(opts)).pipe(\n              map(localDocs => {\n                const docs = entries.map(\n                  (syncEntry, i) => ({syncEntry, localDoc: localDocs.rows[i].doc!})\n                );\n                return {hasNext, docs};\n              }),\n              take(1),\n            );\n          }),\n          exhaustMap(res => this._processUpwardChanges(res)),\n          take(1),\n        );\n      }),\n    ).subscribe(\n      hasNext => {\n        if (hasNext) {\n          this._checkUpwardSync();\n        } else {\n          this._checkDownwardSync();\n        }\n      },\n      err => {\n        this._emitSyncError(err);\n        this.start(false);\n      }\n    );\n  }\n\n  private _checkDownwardSync(): void {\n    this._getLastRemoteCheckpoint().pipe(\n      exhaustMap(since => {\n        const params = `since=${since}&batchSize=${this._opts.changesBatchSize}`;\n        return this._httpClient.get<SyncEntry[]>(`${this._syncUrl}?${params}`);\n      })\n    ).subscribe(changes => {\n      this.stop();\n      this._processDownwardChanges(changes);\n    });\n  }\n\n  private _getLastLocalCheckpoint(): Observable<number> {\n    return this._getLastCheckpoint(this._localCheckpointKey);\n  }\n\n  private _getLastRemoteCheckpoint(): Observable<number> {\n    return this._getLastCheckpoint(this._remoteCheckpointKey);\n  }\n\n  private _getLastCheckpoint(checkpointKey: string): Observable<number> {\n    const db = this._getSyncCheckpointDb();\n    return from(db.get(`_local/${checkpointKey}`)).pipe(\n      map(d => d.checkpoint),\n      catchError(_ => obsOf(0)),\n    );\n  }\n\n  private _setLastLocalCheckpoint(checkpoint: number): Observable<number> {\n    return this._setLastCheckpoint(this._localCheckpointKey, checkpoint);\n  }\n\n  private _setLastRemoteCheckpoint(checkpoint: number): Observable<number> {\n    return this._setLastCheckpoint(this._remoteCheckpointKey, checkpoint);\n  }\n\n  private _setLastCheckpoint(checkpointKey: string, checkpoint: number): Observable<number> {\n    const db = this._getSyncCheckpointDb();\n    const docKey = `_local/${checkpointKey}`;\n    const doc = {_id: docKey, checkpoint} as SyncCheckpoint;\n    return from(db.get(docKey)).pipe(\n      catchError(_ => obsOf({} as SyncCheckpoint)),\n      take(1),\n      exhaustMap(d => from(db.put({...d, ...doc})).pipe(take(1))),\n      catchError(_ => throwError('checkpoint_set_failed')),\n      mapTo(checkpoint),\n    );\n  }\n\n  private _processUpwardChanges(p: {hasNext: boolean, docs: UpwardChange[]}): Observable<boolean> {\n    const payload = p.docs.map(doc => {\n      return {\n        sequence: doc.syncEntry.sequence,\n        table_name: doc.syncEntry.table_name,\n        object_id: doc.syncEntry.object_id,\n        entry_type: doc.syncEntry.entry_type,\n        object: doc.localDoc.object\n      };\n    });\n    return this._httpClient.post<UpwardChangeResult[]>(this._syncUrl, payload).pipe(\n      map(res => res[res.length - 1].sequence),\n      catchError((err: HttpErrorResponse) => {\n        if (err.status !== 409) {\n          return throwError(err);\n        }\n        p.hasNext = true;\n        return this._resolveUpwardConflict(p.docs, err.error);\n      }),\n      exhaustMap(sequence => sequence >= 0 ? this._setLastLocalCheckpoint(sequence) : obsOf(null)),\n      map(_ => p.hasNext),\n    );\n  }\n\n  private _resolveUpwardConflict(\n    docs: UpwardChange[], result: UpwardChangeResult[]\n  ): Observable<number> {\n    const conflictIdx = result.findIndex(r => r.ok === false && r.error === 'conflict')!;\n    const conflict = result[conflictIdx];\n    const conflictDoc = docs.find(d => d.syncEntry.sequence === conflict.sequence)!;\n    const checkpoint = conflictIdx > 0 ? result[conflictIdx - 1].sequence : -1;\n    const localDocsDb = this._getLocalDocsDb();\n    const findReq = this._modelListFindRequest(conflictDoc.syncEntry.table_name, {});\n    findReq.selector['object_id'] = {$gte: conflictDoc.syncEntry.object_id};\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => from(localDocsDb.find(findReq)).pipe(take(1))),\n      exhaustMap(res => {\n        const updDocs = res.docs.map((doc, idx) => {\n          doc.object_id = doc.object.id = conflict.extra.next_id + idx;\n          return doc;\n        });\n        return from(localDocsDb.bulkDocs(updDocs)).pipe(take(1));\n      }),\n      map(_ => checkpoint),\n    );\n  }\n\n  private _processDownwardChanges(syncEntries: SyncEntry[]): void {\n    if (syncEntries == null || syncEntries.length === 0) {\n      this._emitSyncPaused();\n      this.start(false);\n      return;\n    }\n    const changes = syncEntries.map(s => s.id);\n    const url = this._changesUrl;\n    this._httpClient.post<SyncEntry[]>(url, {changes}).pipe(\n      catchError(_ => {\n        this._emitSyncError('network_error');\n        return obsOf([] as SyncEntry[]);\n      }),\n      switchMap(docs => from(\n        changes.map(change => ({change, doc: (docs || []).find(d => d.id === change)}))\n      )),\n      tap(_ => this._emitSyncSyncing()),\n      concatMap(({change, doc}) => doc == null\n        ? throwError(`missing_change_${change}`)\n        : this._processDownwardChange(doc)\n      ),\n      concatMap(change => this._setLastRemoteCheckpoint(change.id))\n    ).subscribe(\n      _ => {},\n      error => {\n        this._emitSyncError(error);\n        this.start(false);\n      },\n      () => {\n        const hasMore = changes.length > 0;\n        if (!hasMore) {\n          this._emitSyncPaused();\n        }\n        this.start(hasMore);\n      }\n    );\n  }\n\n  private _emitSyncError(error: string): void {\n    this._status.next({status: 'error', error});\n  }\n\n  private _emitSyncPaused(): void {\n    this._status.next({status: 'paused'});\n  }\n\n  private _emitSyncSyncing(): void {\n    this._status.next({status: 'syncing'});\n  }\n\n  private _processDownwardChange(change: SyncEntry): Observable<SyncEntry> {\n    if (\n      change.entry_type !== 'insert'\n      && change.entry_type !== 'update'\n      && change.entry_type !== 'delete'\n    ) {\n      return throwError('invalid_entry_type');\n    }\n\n    const baseReq = this._relationalModelIdxObs().pipe(\n      exhaustMap(_ => from(this._database.find(this._syncEntryFindRequest(change))).pipe(take(1))),\n    );\n\n    if (change.entry_type === 'insert') {\n      return baseReq.pipe(\n        exhaustMap(localDocs => {\n          if (localDocs.docs.length !== 0) {\n            return throwError('existing_doc');\n          }\n          return from(this._database.post(this._syncEntryToLocalDoc(change))).pipe(take(1));\n        }),\n        mapTo(change),\n      );\n    }\n\n    return baseReq.pipe(\n      exhaustMap(localDocs => {\n        if (localDocs.docs.length !== 1) {\n          return throwError('unexisting_doc');\n        }\n\n        const localDoc = localDocs.docs[0];\n        const op = from(change.entry_type === 'update'\n          ? this._database.put({...localDoc, object: change.object})\n          : this._database.remove(localDoc));\n        return op.pipe(\n          take(1),\n          mapTo(change),\n        );\n      })\n    );\n  }\n\n  private _modelGetFindRequest(\n    tableName: string, params: ModelGetParams\n  ): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    return {\n      selector: {table_name: tableName, object_id: params.id}\n    };\n  }\n\n  private _modelBulkIdsFindRequest(\n    tableName: string, ids: number[],\n  ): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    return {\n      selector: {\n        table_name: tableName,\n        object_id: {$in: ids}\n      }\n    };\n  }\n\n  private _modelQueryFindRequest(\n    tableName: string, params: ModelQueryParams,\n    index?: PouchDB.Find.CreateIndexResponse<LocalDoc<any>>\n  ): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    const req: PouchDB.Find.FindRequest<LocalDoc<any>> = this._modelListFindRequest(\n      tableName, params, index\n    );\n    return {...req, selector: {...req.selector, ...this._normalizeSelector(params.selector)}};\n  }\n\n  private _modelListFindRequest(\n    tableName: string, params: ModelListParams,\n    index?: PouchDB.Find.CreateIndexResponse<LocalDoc<any>>\n  ): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    const req: PouchDB.Find.FindRequest<LocalDoc<any>> = {\n      selector: {table_name: tableName}\n    };\n    if (params.sort != null) {\n      const {dir, fields} = this._normalizeSortParam(params.sort);\n      req.sort = [{table_name: dir}, ...fields];\n    } else {\n      req.sort = ['table_name', 'object_id'];\n    }\n    if (params.start != null) {\n      req.skip = params.start;\n    }\n    if (params.limit != null) {\n      req.limit = params.limit;\n    }\n    if (index != null) {\n      const idxParts = ((index as any).id || '').split('/');\n      if (idxParts.length === 2) {\n        req.use_index = idxParts[1];\n      }\n    }\n    return req;\n  }\n\n  private _normalizeSelector(selector: PouchDB.Find.Selector): PouchDB.Find.Selector {\n    const normSelector: PouchDB.Find.Selector = {};\n    Object.keys(selector).forEach(key => {\n      normSelector[`object.${key}`] = selector[key];\n    });\n    return normSelector;\n  }\n\n  private _normalizeSortParam(\n    sortParam: {[prop: string]: 'asc' | 'desc'}\n  ): {dir: 'asc' | 'desc', fields: ModelSort[]} {\n    let dir: 'asc' | 'desc' = 'asc';\n    const fields = Object.keys(sortParam).map((key, i) => {\n      const sort: any = {};\n      if (i == 0) { dir = sortParam[key]; }\n      sort[key !== 'object_id' ? `object.${key}` : key] = dir;\n      return sort;\n    });\n    return {dir, fields};\n  }\n\n  private _syncEntryFindRequest(entry: SyncEntry): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    return {selector : this._syncEntryFindSelector(entry)};\n  }\n\n  private _syncEntryFindSelector(entry: SyncEntry): PouchDB.Find.Selector {\n    return {\n      table_name: entry.table_name,\n      object_id: entry.object_id,\n    };\n  }\n\n  private _initLocalDatabase(): void {\n    pouchDBStatic.plugin(pouchDBFindPlugin);\n    pouchDBStatic.plugin(PouchDBDebug);\n    this._database = new pouchDBStatic(this._opts.localDatabaseName, {revs_limit: 1});\n\n    this._database.createIndex(this._relationalModelIdx)\n      .then(_ => {\n        this._emitSyncPaused();\n        this._databaseInit.next(true);\n      })\n      .catch(_ => this._emitSyncError('indexing_failed'));\n  }\n\n  private _syncEntryToLocalDoc(entry: SyncEntry): LocalDoc<any> {\n    return {\n      object_id: entry.object_id,\n      table_name: entry.table_name,\n      object: entry.object\n    };\n  }\n}\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {SYNC_REGISTERED_MODELS} from './registered-models';\n\nexport function registerSyncModel(endpoint: string, tableName: string): void {\n  if (SYNC_REGISTERED_MODELS.find(r => r.tableName === tableName) == null) {\n    const registeredModel = {tableName, endpoint};\n    SYNC_REGISTERED_MODELS.push(registeredModel);\n    console.log(`Registered sync model ${tableName} with endpoint ${endpoint}`);\n  }\n}\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {\n  HttpEvent, HttpErrorResponse, HttpHandler, HttpInterceptor, HttpRequest, HttpResponse\n} from '@angular/common/http';\nimport {Injectable} from '@angular/core';\n\nimport {Observable, throwError} from 'rxjs';\nimport {catchError, map} from 'rxjs/operators';\n\nimport {RegisteredModel} from './registered-model';\nimport {SYNC_REGISTERED_MODELS} from './registered-models';\nimport {SyncService} from './sync-service';\n\n@Injectable()\nexport class OfflineInterceptor implements HttpInterceptor {\n  constructor(private _syncService: SyncService) { }\n\n  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n    return next.handle(req).pipe(\n      catchError((e: HttpErrorResponse) => {\n        if (e.status === 0) {\n          const models = this._checkOfflineRequest(req);\n          if (models.length > 0) {\n            return this._doOfflineRequest(req, models[0], e);\n          }\n        }\n        return throwError(e);\n      })\n    );\n  }\n\n  private _doOfflineRequest(\n    req: HttpRequest<any>,\n    model: RegisteredModel,\n    reqError: HttpErrorResponse\n  ): Observable<HttpEvent<any>> {\n    const method = req.method.toLowerCase();\n    const {exactMatch, relativeUrl} = this._analyzeRequestUrl(req, model);\n    if (exactMatch) {\n      if (method === 'get') {\n        const limit = <any>req.params.get('limit');\n        const start = <any>req.params.get('start');\n        const sort = <any>req.params.get('sort');\n        const fields = <any>req.params.get('fields');\n        const joins = <any>req.params.get('joins');\n        return this._syncService.list(model.tableName, {limit, start, sort, fields, joins}).pipe(\n          catchError(_ => throwError(reqError)),\n          map(res => new HttpResponse({\n            status: 200,\n            statusText: 'OK',\n            url: req.url,\n            body: res\n          })),\n        );\n      } else if (method === 'post') {\n        const obj = req.body;\n        return this._syncService.create(model.tableName, obj).pipe(\n          catchError(_ => throwError(reqError)),\n          map(res => new HttpResponse({\n            status: 201,\n            statusText: 'OK',\n            url: req.url,\n            body: res\n          }))\n        );\n      }\n    } else {\n      if (relativeUrl.length === 1) {\n        const lastUrlPart = relativeUrl[0];\n        if (lastUrlPart === 'delete_all') {\n          const ids = req.body.ids;\n          if (ids != null && ids instanceof Array && ids.length > 0) {\n            return this._syncService.deleteAll(model.tableName, ids).pipe(\n              catchError(_ => throwError(reqError)),\n              map(res => new HttpResponse({\n                status: 200,\n                statusText: 'OK',\n                url: req.url,\n                body: res\n              }))\n            );\n          }\n        } else if (lastUrlPart === 'query') {\n          const params = req.body;\n          return this._syncService.query(model.tableName, params).pipe(\n            catchError(_ => throwError(reqError)),\n            map(res => new HttpResponse({\n              status: 200,\n              statusText: 'OK',\n              url: req.url,\n              body: res\n            }))\n          );\n        } else {\n          const id = parseInt(lastUrlPart, 10);\n          if (!isNaN(id) && id > 0) {\n            let op: Observable<any> | null = null;\n            let successStatus: number = 200;\n            const obj = req.body;\n            if (method === 'get') {\n              op = this._syncService.get(model.tableName, {id});\n              successStatus = 201;\n            } else if (method === 'patch' || method === 'put') {\n              op = this._syncService.update(model.tableName, id, obj);\n            } else if (method === 'delete') {\n              op = this._syncService.delete(model.tableName, id);\n            }\n            if (op != null) {\n              return op.pipe(\n                catchError(_ => throwError(reqError)),\n                map(res => new HttpResponse({\n                  status: successStatus,\n                  statusText: 'OK',\n                  url: req.url,\n                  body: res\n                })),\n              );\n            }\n          }\n        }\n      }\n    }\n    return throwError(reqError);\n  }\n\n  private _analyzeRequestUrl(\n    req: HttpRequest<any>,\n    model: RegisteredModel\n  ): {exactMatch: boolean, relativeUrl: string[]} {\n    const exactMatch = new RegExp('^' + model.endpoint + '$').test(req.url);\n    if (exactMatch) { return {exactMatch, relativeUrl: []}; }\n    const baseUrlParts = model.endpoint.split(/\\/+/);\n    const reqUrlParts = req.url.split(/\\/+/);\n    return {exactMatch, relativeUrl: reqUrlParts.slice(baseUrlParts.length)};\n  }\n\n  private _checkOfflineRequest(req: HttpRequest<any>): RegisteredModel[] {\n    return SYNC_REGISTERED_MODELS.filter(m => new RegExp(`^${m.endpoint}`).test(req.url));\n  }\n}\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {HTTP_INTERCEPTORS} from '@angular/common/http';\nimport {ModuleWithProviders, NgModule} from '@angular/core';\n\nimport {OfflineInterceptor} from './offline-interceptor';\nimport {SYNC_OPTIONS, SyncOptions} from './sync-options';\nimport {SyncService} from './sync-service';\n\n@NgModule({})\nexport class SyncModule {\n  static forRoot(opts: SyncOptions): ModuleWithProviders {\n    return {\n      ngModule: SyncModule,\n      providers: [\n        SyncService,\n        {provide: HTTP_INTERCEPTORS, useClass: OfflineInterceptor, multi: true},\n        {provide: SYNC_OPTIONS, useValue: opts},\n      ]\n    };\n  }\n}\n"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","this","SYNC_REGISTERED_MODELS","SYNC_OPTIONS","InjectionToken","pouchDBStatic","((/** @type {?} */ (PouchDB))).default","PouchDB","pouchDBFindPlugin","((/** @type {?} */ (PouchDBFind))).default","PouchDBFind","SyncService","registerSyncModel","endPoint","tableName","endpoint","find","r","registeredModel","push","console","log","start","immediate","_this","_syncing","_timerSub","timer","_opts","syncInterval","pipe","delayWhen","_","_databaseIsInit","subscribe","_checkSync","stop","unsubscribe","get","params","db","_getLocalDocsDb","exhaustMap","_relationalModelIdxObs","from","_modelGetFindRequest","take","switchMap","res","docs","throwError","obj_1","_subObject","object","fields","joins","zip","map","join","model","id","property","related","forEach","joinEntry","obsOf","of","list","sort","idx","_modelListFindRequest","d","joinTables_1","reduce","prev","cur","req","selector","$in","doc","obj","prop","rel","object_id","create","_nextObjectId","tslib_1.__assign","localDoc","table_name","_database","post","_createLocalSyncEntry","doc_id","entry_type","update","_a","syncEntry","delete","remove","deleteAll","ids","_modelBulkIdsFindRequest","concatMap","toArray","query","_modelQueryFindRequest","joinTables_2","_getLocalSyncDb","_getLocalSyncNumberDb","_getSyncCheckpointDb","_getNextLocalSyncNumber","syncNumber","_id","_localSyncEntryPrefix","sequence","put","_setLocalSyncNumber","_localSyncNumber","catchError","number","idxDef","_normalizeSortParam","dir","concat","createIndex","index","name","_generateIndexName","_relationalModelIdx","f","key","keys","subObj","_checkUpwardSync","_getLastLocalCheckpoint","checkpoint","localSyncDb","gets","firstId","lastId","Math","min","hasNext","entries","localDocsDb","opts","e","include_docs","allDocs","localDocs","rows","_processUpwardChanges","_checkDownwardSync","err","_emitSyncError","_getLastRemoteCheckpoint","since","changesBatchSize","_httpClient","_syncUrl","changes","_processDownwardChanges","_getLastCheckpoint","_localCheckpointKey","_remoteCheckpointKey","checkpointKey","_setLastLocalCheckpoint","_setLastCheckpoint","_setLastRemoteCheckpoint","docKey","mapTo","payload","status","_resolveUpwardConflict","error","result","conflictIdx","findIndex","ok","conflict","conflictDoc","findReq","$gte","updDocs","extra","next_id","bulkDocs","syncEntries","_emitSyncPaused","url","_changesUrl","change","tap","_emitSyncSyncing","_processDownwardChange","hasMore","_status","next","baseReq","_syncEntryFindRequest","_syncEntryToLocalDoc","_normalizeSelector","skip","limit","idxParts","split","use_index","normSelector","sortParam","entry","_syncEntryFindSelector","_initLocalDatabase","plugin","PouchDBDebug","localDatabaseName","revs_limit","then","_databaseInit","catch","type","Injectable","undefined","decorators","Inject","args","HttpClient","BehaviorSubject","asObservable","Subscription","EMPTY","baseUrl","changesPath","docsPath","filter","OfflineInterceptor","intercept","handle","models","_checkOfflineRequest","_doOfflineRequest","reqError","method","toLowerCase","_analyzeRequestUrl","exactMatch","relativeUrl","_syncService","HttpResponse","statusText","body","lastUrlPart","Array","parseInt","isNaN","op","successStatus_1","RegExp","test","baseUrlParts","slice","m","SyncModule","forRoot","ngModule","providers","provide","HTTP_INTERCEPTORS","useClass","multi","useValue","NgModule"],"mappings":"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"}