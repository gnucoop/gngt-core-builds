/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/common/http"),require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("pouchdb"),require("pouchdb-debug"),require("pouchdb-find")):"function"==typeof define&&define.amd?define("@gngt/core/sync",["exports","@angular/common/http","@angular/core","rxjs","rxjs/operators","pouchdb","pouchdb-debug","pouchdb-find"],e):e(((t=t||self).dewco=t.dewco||{},t.dewco.core=t.dewco.core||{},t.dewco.core.sync={}),t.ng.common.http,t.ng.core,t.rxjs,t.rxjs.operators,t.pouchdb,t.pouchdb.debug,t.pouchdb.find)}(this,function(t,f,n,d,h,r,o,i){"use strict";var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};var c=function(){return(c=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},s=[],u=new n.InjectionToken("SYNC_OPTIONS"),p=function(){function t(t,e){this._opts=t,this._httpClient=e,this._status=new d.BehaviorSubject({status:"initializing"}),this.status=this._status.asObservable(),this._timerSub=d.Subscription.EMPTY,this._syncing=!1,this._remoteCheckpointKey="gngt_remote_sync_checkpoint",this._localCheckpointKey="gngt_local_sync_checkpoint",this._localSyncNumber="gngt_local_sync_number",this._localSyncEntryPrefix="gngt_local_sync_entry_",this._relationalModelIdx={index:{name:"relational_model_idx",fields:["table_name","object_id"]}},this._databaseInit=new d.BehaviorSubject(!1),null==this._opts.syncInterval&&(this._opts.syncInterval=3e5),null==this._opts.changesBatchSize&&(this._opts.changesBatchSize=50),this._syncUrl=this._opts.baseUrl+"/"+(this._opts.changesPath||"changes"),this._changesUrl=this._opts.baseUrl+"/"+(this._opts.docsPath||"docs"),this._initLocalDatabase(),this._databaseIsInit=this._databaseInit.pipe(h.filter(function(t){return t}))}return t.prototype.start=function(t){var e=this;void 0===t&&(t=!0),this._syncing||(this._syncing=!0,this._timerSub=d.timer(t?0:this._opts.syncInterval,this._opts.syncInterval).pipe(h.delayWhen(function(t){return e._databaseIsInit})).subscribe(function(t){return e._checkSync()}))},t.prototype.stop=function(){this._syncing&&(this._timerSub.unsubscribe(),this._syncing=!1)},t.prototype.get=function(e,r){var o=this,i=this._getLocalDocsDb();return this._databaseIsInit.pipe(h.exhaustMap(function(t){return o._relationalModelIdxObs()}),h.exhaustMap(function(t){return d.from(i.find(o._modelGetFindRequest(e,r))).pipe(h.take(1))}),h.switchMap(function(t){if(1!==t.docs.length)return d.throwError("not_found");var n=o._subObject(t.docs[0].object,r.fields);return null!=r.joins?d.zip.apply(void 0,r.joins.map(function(e){return d.from(i.find(o._modelGetFindRequest(e.model,{id:n[e.property],fields:e.fields}))).pipe(h.take(1),h.map(function(t){return 1===t.docs.length?t.docs[0].object:null}),h.map(function(t){return{join:e,related:t}}))})).pipe(h.map(function(t){return t.forEach(function(t){n[t.join.property]=t.related}),n})):d.of(n)}))},t.prototype.list=function(e,o){var i=this,a=this._getLocalDocsDb();return this._databaseIsInit.pipe(h.exhaustMap(function(t){return i._relationalModelIdxObs({tableName:e,sort:o.sort})}),h.exhaustMap(function(t){return d.from(a.find(i._modelListFindRequest(e,o,t))).pipe(h.take(1))}),h.switchMap(function(n){if(null==o.joins)return d.of(n.docs.map(function(t){return i._subObject(t.object,o.fields)}));var r=o.joins.reduce(function(t,e){return t[e.model]=n.docs.map(function(t){return t.object[e.property]}),t},{});return d.zip.apply(void 0,o.joins.map(function(e){var t=i._modelListFindRequest(e.model,{fields:e.fields});return t.selector.object_id={$in:r[e.model]},d.from(a.find(t)).pipe(h.take(1),h.map(function(t){return{join:e,related:t.docs}}))})).pipe(h.map(function(e){return n.docs.map(function(t){var r=t.object;return e.forEach(function(t){var e=t.join.property,n=t.related.find(function(t){return t.object_id===r[e]});r[e]=null!=n?n.object:null}),i._subObject(r,o.fields)})}))}))},t.prototype.create=function(r,t){var o=this;return this._databaseIsInit.pipe(h.exhaustMap(function(t){return o._nextObjectId(r)}),h.exhaustMap(function(e){t=c({id:e},t);var n={table_name:r,object_id:e};return d.from(o._database.post(c({},n,{object:t}))).pipe(h.exhaustMap(function(t){return o._createLocalSyncEntry(c({doc_id:t.id,entry_type:"insert"},n))}),h.map(function(t){return e}))}),h.take(1))},t.prototype.update=function(n,r,o){var i=this,a=this._getLocalDocsDb();return this._databaseIsInit.pipe(h.exhaustMap(function(t){return d.from(a.find(i._modelGetFindRequest(n,{id:r}))).pipe(h.take(1))}),h.exhaustMap(function(t){if(1!==t.docs.length)return d.throwError("not_found");var e=c({},t.docs[0],{object:o});return d.from(a.post(e)).pipe(h.take(1))}),h.exhaustMap(function(t){var e={doc_id:t.id,table_name:n,object_id:r,entry_type:"update"};return i._createLocalSyncEntry(e)}),h.take(1),h.map(function(t){return r}))},t.prototype.delete=function(n,r){var o=this,i=this._getLocalDocsDb();return this._databaseIsInit.pipe(h.exhaustMap(function(t){return d.from(i.find(o._modelGetFindRequest(n,{id:r}))).pipe(h.take(1))}),h.exhaustMap(function(t){if(1!==t.docs.length)return d.throwError("not_found");var e=t.docs[0];return d.from(i.remove(e)).pipe(h.take(1))}),h.exhaustMap(function(t){var e={doc_id:t.id,table_name:n,object_id:r,entry_type:"delete"};return o._createLocalSyncEntry(e)}),h.take(1),h.map(function(t){return r}))},t.prototype._getLocalDocsDb=function(){return this._database},t.prototype._getLocalSyncDb=function(){return this._database},t.prototype._getLocalSyncNumberDb=function(){return this._database},t.prototype._getSyncCheckpointDb=function(){return this._database},t.prototype._createLocalSyncEntry=function(t){var n=this;return this._getNextLocalSyncNumber().pipe(h.exhaustMap(function(e){return t._id="_local/"+n._localSyncEntryPrefix+e,t.sequence=e,d.from(n._database.put(t)).pipe(h.take(1),h.exhaustMap(function(t){return n._setLocalSyncNumber(e)}),h.take(1))}))},t.prototype._setLocalSyncNumber=function(e){var n=this._getLocalSyncNumberDb(),r="_local/"+this._localSyncNumber;return d.from(n.get(r)).pipe(h.take(1),h.catchError(function(t){return d.of({_id:r,number:0})}),h.exhaustMap(function(t){return d.from(n.post(c({},t,{number:e}))).pipe(h.take(1))}),h.map(function(t){return e}))},t.prototype._getNextLocalSyncNumber=function(){var t=this._getLocalSyncNumberDb();return d.from(t.get("_local/"+this._localSyncNumber)).pipe(h.take(1),h.map(function(t){return t.number+1}),h.catchError(function(t){return d.of(1)}))},t.prototype._nextObjectId=function(e){var n=this,r={object_id:"desc"},o=this._getLocalDocsDb();return this._relationalModelIdxObs({tableName:e,sort:r}).pipe(h.exhaustMap(function(t){return d.from(o.find(n._modelListFindRequest(e,{sort:r},t))).pipe(h.take(1))}),h.map(function(t){return 0<t.docs.length?t.docs[0].object_id+1:1}))},t.prototype._relationalModelIdxObs=function(t){if(null!=t&&null!=t.sort){var e=this._normalizeSortParam(t.sort),n=e.dir,r=e.fields;if(0<(r=[{table_name:n}].concat(r)).length)return d.from(this._database.createIndex({index:{name:this._generateIndexName(t.tableName,r),fields:r}}))}return d.from(this._database.createIndex(this._relationalModelIdx)).pipe(h.take(1))},t.prototype._generateIndexName=function(t,e){return"idx___"+t+"___"+e.map(function(t){var e=Object.keys(t)[0];return e+"__"+t[e]}).join("___")},t.prototype._subObject=function(e,t){if(null==e||null==t)return e;e=e||{};var n={};return(t||[]).forEach(function(t){return n[t]=e[t]}),n},t.prototype._checkSync=function(){this._checkUpwardSync()},t.prototype._checkUpwardSync=function(){var u=this;d.zip(this._getLastLocalCheckpoint(),this._getNextLocalSyncNumber()).pipe(h.exhaustMap(function(t){var e=t[0],n=t[1],r=u._getLocalSyncDb(),o=[],i=e+1,a=Math.min(i+u._opts.changesBatchSize-1,n-1);if(a<=e)return d.of(!1);var c=a<n-1;u.stop();for(var s=i;s<=a;s++)o.push(d.from(r.get("_local/"+u._localSyncEntryPrefix+s)));return d.zip.apply(void 0,o).pipe(h.exhaustMap(function(e){var t=u._getLocalDocsDb(),n={keys:e.map(function(t){return t.doc_id}),include_docs:!0};return d.from(t.allDocs(n)).pipe(h.map(function(n){var t=e.map(function(t,e){return{syncEntry:t,localDoc:n.rows[e].doc}});return{hasNext:c,docs:t}}),h.take(1))}),h.exhaustMap(function(t){return u._processUpwardChanges(t)}),h.take(1))})).subscribe(function(t){t?u._checkUpwardSync():u._checkDownwardSync()},function(t){u._emitSyncError(t),u.start(!1)})},t.prototype._checkDownwardSync=function(){var n=this;this._getLastRemoteCheckpoint().pipe(h.exhaustMap(function(t){var e="since="+t+"&batchSize="+n._opts.changesBatchSize;return n._httpClient.get(n._syncUrl+"?"+e)})).subscribe(function(t){n.stop(),n._processDownwardChanges(t)})},t.prototype._getLastLocalCheckpoint=function(){return this._getLastCheckpoint(this._localCheckpointKey)},t.prototype._getLastRemoteCheckpoint=function(){return this._getLastCheckpoint(this._remoteCheckpointKey)},t.prototype._getLastCheckpoint=function(t){var e=this._getSyncCheckpointDb();return d.from(e.get("_local/"+t)).pipe(h.map(function(t){return t.checkpoint}),h.catchError(function(t){return d.of(0)}))},t.prototype._setLastLocalCheckpoint=function(t){return this._setLastCheckpoint(this._localCheckpointKey,t)},t.prototype._setLastRemoteCheckpoint=function(t){return this._setLastCheckpoint(this._remoteCheckpointKey,t)},t.prototype._setLastCheckpoint=function(t,e){var n=this._getSyncCheckpointDb(),r="_local/"+t,o={_id:r,checkpoint:e};return d.from(n.get(r)).pipe(h.catchError(function(t){return d.of({})}),h.take(1),h.exhaustMap(function(t){return d.from(n.put(c({},t,o))).pipe(h.take(1))}),h.catchError(function(t){return d.throwError("checkpoint_set_failed")}),h.mapTo(e))},t.prototype._processUpwardChanges=function(e){var n=this,t=e.docs.map(function(t){return{sequence:t.syncEntry.sequence,table_name:t.syncEntry.table_name,object_id:t.syncEntry.object_id,entry_type:t.syncEntry.entry_type,object:t.localDoc.object}});return this._httpClient.post(this._syncUrl,t).pipe(h.map(function(t){return t[t.length-1].sequence}),h.catchError(function(t){return 409!==t.status?d.throwError(t):(e.hasNext=!0,n._resolveUpwardConflict(e.docs,t.error))}),h.exhaustMap(function(t){return 0<=t?n._setLastLocalCheckpoint(t):d.of(null)}),h.map(function(t){return e.hasNext}))},t.prototype._resolveUpwardConflict=function(t,e){var n=e.findIndex(function(t){return!1===t.ok&&"conflict"===t.error}),r=e[n],o=t.find(function(t){return t.syncEntry.sequence===r.sequence}),i=0<n?e[n-1].sequence:-1,a=this._getLocalDocsDb(),c=this._modelListFindRequest(o.syncEntry.table_name,{});return c.selector.object_id={$gte:o.syncEntry.object_id},this._databaseIsInit.pipe(h.exhaustMap(function(t){return d.from(a.find(c)).pipe(h.take(1))}),h.exhaustMap(function(t){var e=t.docs.map(function(t,e){return t.object_id=t.object.id=r.extra.next_id+e,t});return d.from(a.bulkDocs(e)).pipe(h.take(1))}),h.map(function(t){return i}))},t.prototype._processDownwardChanges=function(t){var r=this;if(null==t||0===t.length)return this._emitSyncPaused(),void this.start(!1);var e=t.map(function(t){return t.id}),n=this._changesUrl;this._httpClient.post(n,{changes:e}).pipe(h.catchError(function(t){return r._emitSyncError("network_error"),d.of([])}),h.switchMap(function(t){return d.from(e.map(function(e){return{change:e,doc:(t||[]).find(function(t){return t.id===e})}}))}),h.tap(function(t){return r._emitSyncSyncing()}),h.concatMap(function(t){var e=t.change,n=t.doc;return null==n?d.throwError("missing_change_"+e):r._processDownwardChange(n)}),h.concatMap(function(t){return r._setLastRemoteCheckpoint(t.id)})).subscribe(function(t){},function(t){r._emitSyncError(t),r.start(!1)},function(){var t=0<e.length;t||r._emitSyncPaused(),r.start(t)})},t.prototype._emitSyncError=function(t){this._status.next({status:"error",error:t})},t.prototype._emitSyncPaused=function(){this._status.next({status:"paused"})},t.prototype._emitSyncSyncing=function(){this._status.next({status:"syncing"})},t.prototype._processDownwardChange=function(n){var r=this;if("insert"!==n.entry_type&&"update"!==n.entry_type&&"delete"!==n.entry_type)return d.throwError("invalid_entry_type");var t=this._relationalModelIdxObs().pipe(h.exhaustMap(function(t){return d.from(r._database.find(r._syncEntryFindRequest(n))).pipe(h.take(1))}));return"insert"===n.entry_type?t.pipe(h.exhaustMap(function(t){return 0!==t.docs.length?d.throwError("existing_doc"):d.from(r._database.post(r._syncEntryToLocalDoc(n))).pipe(h.take(1))}),h.mapTo(n)):t.pipe(h.exhaustMap(function(t){if(1!==t.docs.length)return d.throwError("unexisting_doc");var e=t.docs[0];return d.from("update"===n.entry_type?r._database.put(c({},e,{object:n.object})):r._database.remove(e)).pipe(h.take(1),h.mapTo(n))}))},t.prototype._modelGetFindRequest=function(t,e){return{selector:{table_name:t,object_id:e.id}}},t.prototype._modelListFindRequest=function(t,e,n){var r={selector:{table_name:t}};if(null!=e.sort){var o=this._normalizeSortParam(e.sort),i=o.dir,a=o.fields;r.sort=[{table_name:i}].concat(a)}else r.sort=["table_name","object_id"];if(null!=e.start&&(r.skip=e.start),null!=e.limit&&(r.limit=e.limit),null!=n){var c=(n.id||"").split("/");2===c.length&&(r.use_index=c[1])}return r},t.prototype._normalizeSortParam=function(r){var o="asc",t=Object.keys(r).map(function(t,e){var n={};return 0==e&&(o=r[t]),n["object_id"!==t?"object."+t:t]=o,n});return{dir:o,fields:t}},t.prototype._syncEntryFindRequest=function(t){return{selector:this._syncEntryFindSelector(t)}},t.prototype._syncEntryFindSelector=function(t){return{table_name:t.table_name,object_id:t.object_id}},t.prototype._initLocalDatabase=function(){var e=this;r.plugin(i),r.plugin(o),this._database=new r(this._opts.localDatabaseName,{revs_limit:1}),this._database.createIndex(this._relationalModelIdx).then(function(t){e._emitSyncPaused(),e._databaseInit.next(!0)}).catch(function(t){return e._emitSyncError("indexing_failed")})},t.prototype._syncEntryToLocalDoc=function(t){return{object_id:t.object_id,table_name:t.table_name,object:t.object}},t.decorators=[{type:n.Injectable}],t.ctorParameters=function(){return[{type:void 0,decorators:[{type:n.Inject,args:[u]}]},{type:f.HttpClient}]},t}(),l=function(){function t(t){this._syncService=t}return t.prototype.intercept=function(n,t){var r=this;return t.handle(n).pipe(h.catchError(function(t){if(0===t.status){var e=r._checkOfflineRequest(n);if(0<e.length)return r._doOfflineRequest(n,e[0],t)}return d.throwError(t)}))},t.prototype._doOfflineRequest=function(e,t,n){var r=e.method.toLowerCase(),o=this._analyzeRequestUrl(e,t),i=o.exactMatch,a=o.relativeUrl;if("get"===r){if(i){var c=e.params.get("limit"),s=e.params.get("start"),u=e.params.get("sort"),p=e.params.get("fields"),l=e.params.get("joins");return this._syncService.list(t.tableName,{limit:c,start:s,sort:u,fields:p,joins:l}).pipe(h.catchError(function(t){return d.throwError(n)}),h.map(function(t){return new f.HttpResponse({status:200,statusText:"OK",url:e.url,body:t})}))}if(1===a.length){var _=parseInt(a[0],10);if(!isNaN(_)&&0<_)return this._syncService.get(t.tableName,{id:_}).pipe(h.catchError(function(t){return d.throwError(n)}),h.map(function(t){return new f.HttpResponse({status:200,statusText:"OK",url:e.url,body:t})}))}}return d.throwError(n)},t.prototype._analyzeRequestUrl=function(t,e){var n=new RegExp("^"+e.endpoint+"$").test(t.url);if(n)return{exactMatch:n,relativeUrl:[]};var r=e.endpoint.split(/\/+/);return{exactMatch:n,relativeUrl:t.url.split(/\/+/).slice(r.length)}},t.prototype._checkOfflineRequest=function(e){return s.filter(function(t){return new RegExp("^"+t.endpoint).test(e.url)})},t.decorators=[{type:n.Injectable}],t.ctorParameters=function(){return[{type:p}]},t}();var e="__gngt_annotations__";var _=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[p,{provide:f.HTTP_INTERCEPTORS,useClass:l,multi:!0},{provide:u,useValue:t}]}},e.decorators=[{type:n.NgModule,args:[{}]}],e}();t.OfflineInterceptor=l,t.SYNC_OPTIONS=u,t.SyncModel=function(o){return function(t){return(t.hasOwnProperty(e)?t[e]:Object.defineProperty(t,e,{value:[]})[e]).push({sync_model:!0}),function(r){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=r.apply(this,t)||this;return function(t,e){if(null==s.find(function(t){return t.tableName===e})){var n={tableName:e,endpoint:t};s.push(n),console.log("Registered sync model "+e+" with endpoint "+t)}}(n.endPoint,o.tableName),n}return function(t,e){function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(t,r),t}(t)}},t.SyncModule=_,t.SyncService=p,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=core-sync.umd.min.js.map
