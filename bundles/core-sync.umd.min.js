/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/common/http"),require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("pouchdb"),require("pouchdb-debug"),require("pouchdb-find")):"function"==typeof define&&define.amd?define("@gngt/core/sync",["exports","@angular/common/http","@angular/core","rxjs","rxjs/operators","pouchdb","pouchdb-debug","pouchdb-find"],e):e(((t=t||self).gngt=t.gngt||{},t.gngt.core=t.gngt.core||{},t.gngt.core.sync={}),t.ng.common.http,t.ng.core,t.rxjs,t.rxjs.operators,t.pouchdb,t.pouchdb.debug,t.pouchdb.find)}(this,function(t,g,e,v,j,n,r,o){"use strict";var i="default"in n?n.default:n,a="default"in o?o.default:o,c=function(){return(c=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},s=[],u=new e.InjectionToken("SYNC_OPTIONS");var p=i||n,l=a||o,d=(f.prototype.registerSyncModel=function(t,e){!function(t,e){if(null==s.find(function(t){return t.tableName===e})){var n={tableName:e,endpoint:t};s.push(n),console.log("Registered sync model "+e+" with endpoint "+t)}}(t,e)},f.prototype.start=function(t){var e=this;void 0===t&&(t=!0),this._syncing||(this._syncing=!0,this._timerSub=v.timer(t?0:this._opts.syncInterval,this._opts.syncInterval).pipe(j.delayWhen(function(t){return e._databaseIsInit})).subscribe(function(t){return e._checkSync()}))},f.prototype.stop=function(){this._syncing&&(this._timerSub.unsubscribe(),this._syncing=!1)},f.prototype.get=function(e,r){var o=this,i=this._getLocalDocsDb();return this._databaseIsInit.pipe(j.exhaustMap(function(t){return o._relationalModelIdxObs()}),j.exhaustMap(function(t){return v.from(i.find(o._modelGetFindRequest(e,r)))}),j.take(1),j.switchMap(function(t){if(1!==t.docs.length)return v.throwError("not_found");var n=o._subObject(t.docs[0].object,r.fields);return null!=r.joins?v.zip.apply(void 0,r.joins.map(function(e){return v.from(i.find(o._modelGetFindRequest(e.model,{id:n[e.property],fields:e.fields}))).pipe(j.take(1),j.map(function(t){return 1===t.docs.length?t.docs[0].object:null}),j.map(function(t){return{join:e,related:t}}))})).pipe(j.map(function(t){return t.forEach(function(t){n[t.join.property]=t.related}),n})):v.of(n)}),j.take(1))},f.prototype.list=function(e,o){var i=this,a=this._getLocalDocsDb();return this._databaseIsInit.pipe(j.exhaustMap(function(t){return i._relationalModelIdxObs({tableName:e,sort:o.sort})}),j.exhaustMap(function(t){return v.from(a.find(i._modelListFindRequest(e,o,t)))}),j.take(1),j.switchMap(function(n){if(null==o.joins)return v.of(n.docs.map(function(t){return i._subObject(t.object,o.fields)}));var r=o.joins.reduce(function(t,e){return t[e.model]=n.docs.map(function(t){return t.object[e.property]}),t},{});return v.zip.apply(void 0,o.joins.map(function(e){var t=i._modelListFindRequest(e.model,{fields:e.fields});return t.selector.object_id={$in:r[e.model]},v.from(a.find(t)).pipe(j.take(1),j.map(function(t){return{join:e,related:t.docs}}))})).pipe(j.map(function(e){return n.docs.map(function(t){var r=t.object;return e.forEach(function(t){var e=t.join.property,n=t.related.find(function(t){return t.object_id===r[e]});r[e]=null!=n?n.object:null}),i._subObject(r,o.fields)})}))}),j.take(1))},f.prototype.create=function(n,r){var o=this;return this._databaseIsInit.pipe(j.exhaustMap(function(t){return o._nextObjectId(n)}),j.take(1),j.exhaustMap(function(t){r=c({id:t},r);var e={table_name:n,object_id:t};return v.from(o._database.post(c({},e,{object:r}))).pipe(j.exhaustMap(function(t){return o._createLocalSyncEntry(c({doc_id:t.id,entry_type:"insert"},e)).pipe(j.map(function(){return r}))}))}),j.take(1))},f.prototype.update=function(o,e,n){var i=this,r=this._getLocalDocsDb();return this._databaseIsInit.pipe(j.exhaustMap(function(t){return v.from(r.find(i._modelGetFindRequest(o,{id:e})))}),j.take(1),j.exhaustMap(function(t){if(1!==t.docs.length)return v.throwError("not_found");var e=c({},t.docs[0],{object:n});return v.from(r.post(e)).pipe(j.map(function(t){return{res:t,localDoc:e}}))}),j.take(1),j.exhaustMap(function(t){var e=t.res,n=t.localDoc,r={doc_id:e.id,table_name:o,object_id:n.object_id,entry_type:"update"};return i._createLocalSyncEntry(r).pipe(j.map(function(){return n.object}))}),j.take(1))},f.prototype.delete=function(o,e){var i=this,n=this._getLocalDocsDb();return this._databaseIsInit.pipe(j.exhaustMap(function(t){return v.from(n.find(i._modelGetFindRequest(o,{id:e})))}),j.take(1),j.exhaustMap(function(t){if(1!==t.docs.length)return v.throwError("not_found");var e=t.docs[0];return v.from(n.remove(e)).pipe(j.map(function(t){return{res:t,localDoc:e}}))}),j.take(1),j.exhaustMap(function(t){var e=t.res,n=t.localDoc,r={doc_id:e.id,table_name:o,object_id:n.object_id,entry_type:"delete"};return i._createLocalSyncEntry(r).pipe(j.map(function(){return n.object}))}),j.take(1))},f.prototype.deleteAll=function(o,e){var i=this,n=this._getLocalDocsDb();return this._databaseIsInit.pipe(j.exhaustMap(function(t){return v.from(n.find(i._modelBulkIdsFindRequest(o,e)))}),j.take(1),j.concatMap(function(t){return 1!==t.docs.length?v.throwError("not_found"):v.from(t.docs)}),j.concatMap(function(e){return v.from(n.remove(e)).pipe(j.map(function(t){return{res:t,localDoc:e}}))}),j.concatMap(function(t){var e=t.res,n=t.localDoc,r={doc_id:e.id,table_name:o,object_id:n.object_id,entry_type:"delete"};return i._createLocalSyncEntry(r).pipe(j.map(function(){return n.object}))}),j.take(e.length),j.toArray())},f.prototype.query=function(e,o){var i=this,a=this._getLocalDocsDb();return this._databaseIsInit.pipe(j.exhaustMap(function(t){return i._relationalModelIdxObs({tableName:e,sort:o.sort})}),j.take(1),j.exhaustMap(function(t){return v.from(a.find(i._modelQueryFindRequest(e,o,t)))}),j.take(1),j.switchMap(function(n){if(null==o.joins)return v.of(n.docs.map(function(t){return i._subObject(t.object,o.fields)}));var r=o.joins.reduce(function(t,e){return t[e.model]=n.docs.map(function(t){return t.object[e.property]}),t},{});return v.zip.apply(void 0,o.joins.map(function(e){var t=i._modelListFindRequest(e.model,{fields:e.fields});return t.selector.object_id={$in:r[e.model]},v.from(a.find(t)).pipe(j.take(1),j.map(function(t){return{join:e,related:t.docs}}))})).pipe(j.map(function(e){return n.docs.map(function(t){var r=t.object;return e.forEach(function(t){var e=t.join.property,n=t.related.find(function(t){return t.object_id===r[e]});r[e]=null!=n?n.object:null}),i._subObject(r,o.fields)})}))}),j.take(1))},f.prototype._getLocalDocsDb=function(){return this._database},f.prototype._getLocalSyncDb=function(){return this._database},f.prototype._getLocalSyncNumberDb=function(){return this._database},f.prototype._getSyncCheckpointDb=function(){return this._database},f.prototype._createLocalSyncEntry=function(t){var n=this;return this._getNextLocalSyncNumber().pipe(j.exhaustMap(function(e){return t._id="_local/"+n._localSyncEntryPrefix+e,t.sequence=e,v.from(n._database.put(t)).pipe(j.take(1),j.exhaustMap(function(t){return n._setLocalSyncNumber(e)}),j.take(1))}))},f.prototype._setLocalSyncNumber=function(e){var n=this._getLocalSyncNumberDb(),r="_local/"+this._localSyncNumber;return v.from(n.get(r)).pipe(j.take(1),j.catchError(function(t){return v.of({_id:r,number:0})}),j.exhaustMap(function(t){return v.from(n.post(c({},t,{number:e}))).pipe(j.take(1))}),j.map(function(t){return e}))},f.prototype._getNextLocalSyncNumber=function(){var t=this._getLocalSyncNumberDb();return v.from(t.get("_local/"+this._localSyncNumber)).pipe(j.take(1),j.map(function(t){return t.number+1}),j.catchError(function(t){return v.of(1)}))},f.prototype._nextObjectId=function(e){var n=this,r={object_id:"desc"},o=this._getLocalDocsDb();return this._relationalModelIdxObs({tableName:e,sort:r}).pipe(j.exhaustMap(function(t){return v.from(o.find(n._modelListFindRequest(e,{sort:r},t))).pipe(j.take(1))}),j.map(function(t){return 0<t.docs.length?t.docs[0].object_id+1:1}))},f.prototype._relationalModelIdxObs=function(t){if(null!=t&&null!=t.sort){var e=this._normalizeSortParam(t.sort),n=e.dir,r=e.fields;if(0<(r=[{table_name:n}].concat(r)).length)return v.from(this._database.createIndex({index:{name:this._generateIndexName(t.tableName,r),fields:r}}))}return v.from(this._database.createIndex(this._relationalModelIdx)).pipe(j.take(1))},f.prototype._generateIndexName=function(t,e){return"idx___"+t+"___"+e.map(function(t){var e=Object.keys(t)[0];return e+"__"+t[e]}).join("___")},f.prototype._subObject=function(e,t){if(null==e||null==t)return e;e=e||{};var n={};return(t||[]).forEach(function(t){return n[t]=e[t]}),n},f.prototype._checkSync=function(){this._checkUpwardSync()},f.prototype._checkUpwardSync=function(){var u=this;v.zip(this._getLastLocalCheckpoint(),this._getNextLocalSyncNumber()).pipe(j.exhaustMap(function(t){var e=t[0],n=t[1],r=u._getLocalSyncDb(),o=[],i=e+1,a=Math.min(i+u._opts.changesBatchSize-1,n-1);if(a<=e)return v.of(!1);var c=a<n-1;u.stop();for(var s=i;s<=a;s++)o.push(v.from(r.get("_local/"+u._localSyncEntryPrefix+s)));return v.zip.apply(void 0,o).pipe(j.exhaustMap(function(e){var t=u._getLocalDocsDb(),n={keys:e.map(function(t){return t.doc_id}),include_docs:!0};return v.from(t.allDocs(n)).pipe(j.map(function(n){var t=e.map(function(t,e){return{syncEntry:t,localDoc:n.rows[e].doc}});return{hasNext:c,docs:t}}),j.take(1))}),j.exhaustMap(function(t){return u._processUpwardChanges(t)}),j.take(1))})).subscribe(function(t){t?u._checkUpwardSync():u._checkDownwardSync()},function(t){u._emitSyncError(t),u.start(!1)})},f.prototype._checkDownwardSync=function(){var n=this;this._getLastRemoteCheckpoint().pipe(j.exhaustMap(function(t){var e="since="+t+"&batchSize="+n._opts.changesBatchSize;return n._httpClient.get(n._syncUrl+"?"+e)})).subscribe(function(t){n.stop(),n._processDownwardChanges(t)})},f.prototype._getLastLocalCheckpoint=function(){return this._getLastCheckpoint(this._localCheckpointKey)},f.prototype._getLastRemoteCheckpoint=function(){return this._getLastCheckpoint(this._remoteCheckpointKey)},f.prototype._getLastCheckpoint=function(t){var e=this._getSyncCheckpointDb();return v.from(e.get("_local/"+t)).pipe(j.map(function(t){return t.checkpoint}),j.catchError(function(t){return v.of(0)}))},f.prototype._setLastLocalCheckpoint=function(t){return this._setLastCheckpoint(this._localCheckpointKey,t)},f.prototype._setLastRemoteCheckpoint=function(t){return this._setLastCheckpoint(this._remoteCheckpointKey,t)},f.prototype._setLastCheckpoint=function(t,e){var n=this._getSyncCheckpointDb(),r="_local/"+t,o={_id:r,checkpoint:e};return v.from(n.get(r)).pipe(j.catchError(function(t){return v.of({})}),j.take(1),j.exhaustMap(function(t){return v.from(n.put(c({},t,o))).pipe(j.take(1))}),j.catchError(function(t){return v.throwError("checkpoint_set_failed")}),j.mapTo(e))},f.prototype._processUpwardChanges=function(e){var n=this,t=e.docs.map(function(t){return{sequence:t.syncEntry.sequence,table_name:t.syncEntry.table_name,object_id:t.syncEntry.object_id,entry_type:t.syncEntry.entry_type,object:t.localDoc.object}});return this._httpClient.post(this._syncUrl,t).pipe(j.map(function(t){return t[t.length-1].sequence}),j.catchError(function(t){return 409!==t.status?v.throwError(t):(e.hasNext=!0,n._resolveUpwardConflict(e.docs,t.error))}),j.exhaustMap(function(t){return 0<=t?n._setLastLocalCheckpoint(t):v.of(null)}),j.map(function(t){return e.hasNext}))},f.prototype._resolveUpwardConflict=function(t,e){var n=e.findIndex(function(t){return!1===t.ok&&"conflict"===t.error}),r=e[n],o=t.find(function(t){return t.syncEntry.sequence===r.sequence}),i=0<n?e[n-1].sequence:-1,a=this._getLocalDocsDb(),c=this._modelListFindRequest(o.syncEntry.table_name,{});return c.selector.object_id={$gte:o.syncEntry.object_id},this._databaseIsInit.pipe(j.exhaustMap(function(t){return v.from(a.find(c)).pipe(j.take(1))}),j.exhaustMap(function(t){var e=t.docs.map(function(t,e){return t.object_id=t.object.id=r.extra.next_id+e,t});return v.from(a.bulkDocs(e)).pipe(j.take(1))}),j.map(function(t){return i}))},f.prototype._processDownwardChanges=function(t){var r=this;if(null==t||0===t.length)return this._emitSyncPaused(),void this.start(!1);var e=t.map(function(t){return t.id}),n=this._changesUrl;this._httpClient.post(n,{changes:e}).pipe(j.catchError(function(t){return r._emitSyncError("network_error"),v.of([])}),j.switchMap(function(t){return v.from(e.map(function(e){return{change:e,doc:(t||[]).find(function(t){return t.id===e})}}))}),j.tap(function(t){return r._emitSyncSyncing()}),j.concatMap(function(t){var e=t.change,n=t.doc;return null==n?v.throwError("missing_change_"+e):r._processDownwardChange(n)}),j.concatMap(function(t){return r._setLastRemoteCheckpoint(t.id)})).subscribe(function(t){},function(t){r._emitSyncError(t),r.start(!1)},function(){var t=0<e.length;t||r._emitSyncPaused(),r.start(t)})},f.prototype._emitSyncError=function(t){this._status.next({status:"error",error:t})},f.prototype._emitSyncPaused=function(){this._status.next({status:"paused"})},f.prototype._emitSyncSyncing=function(){this._status.next({status:"syncing"})},f.prototype._processDownwardChange=function(n){var r=this;if("insert"!==n.entry_type&&"update"!==n.entry_type&&"delete"!==n.entry_type)return v.throwError("invalid_entry_type");var t=this._relationalModelIdxObs().pipe(j.exhaustMap(function(t){return v.from(r._database.find(r._syncEntryFindRequest(n))).pipe(j.take(1))}));return"insert"===n.entry_type?t.pipe(j.exhaustMap(function(t){return 0!==t.docs.length?v.throwError("existing_doc"):v.from(r._database.post(r._syncEntryToLocalDoc(n))).pipe(j.take(1))}),j.mapTo(n)):t.pipe(j.exhaustMap(function(t){if(1!==t.docs.length)return v.throwError("unexisting_doc");var e=t.docs[0];return v.from("update"===n.entry_type?r._database.put(c({},e,{object:n.object})):r._database.remove(e)).pipe(j.take(1),j.mapTo(n))}))},f.prototype._modelGetFindRequest=function(t,e){return{selector:{table_name:t,object_id:e.id}}},f.prototype._modelBulkIdsFindRequest=function(t,e){return{selector:{table_name:t,object_id:{$in:e}}}},f.prototype._modelQueryFindRequest=function(t,e,n){var r=this._modelListFindRequest(t,e,n);return c({},r,{selector:c({},r.selector,this._normalizeSelector(e.selector))})},f.prototype._modelListFindRequest=function(t,e,n){var r={selector:{table_name:t}};if(null!=e.sort){var o=this._normalizeSortParam(e.sort),i=o.dir,a=o.fields;r.sort=[{table_name:i}].concat(a)}else r.sort=["table_name","object_id"];if(null!=e.start&&(r.skip=e.start),null!=e.limit&&(r.limit=e.limit),null!=n){var c=(n.id||"").split("/");2===c.length&&(r.use_index=c[1])}return r},f.prototype._normalizeSelector=function(e){var n={};return Object.keys(e).forEach(function(t){n["object."+t]=e[t]}),n},f.prototype._normalizeSortParam=function(r){var o="asc",t=Object.keys(r).map(function(t,e){var n={};return 0==e&&(o=r[t]),n["object_id"!==t?"object."+t:t]=o,n});return{dir:o,fields:t}},f.prototype._syncEntryFindRequest=function(t){return{selector:this._syncEntryFindSelector(t)}},f.prototype._syncEntryFindSelector=function(t){return{table_name:t.table_name,object_id:t.object_id}},f.prototype._initLocalDatabase=function(){var e=this;p.plugin(l),p.plugin(r),this._database=new p(this._opts.localDatabaseName,{revs_limit:1}),this._database.createIndex(this._relationalModelIdx).then(function(t){e._emitSyncPaused(),e._databaseInit.next(!0)}).catch(function(t){return e._emitSyncError("indexing_failed")})},f.prototype._syncEntryToLocalDoc=function(t){return{object_id:t.object_id,table_name:t.table_name,object:t.object}},f.decorators=[{type:e.Injectable}],f.ctorParameters=function(){return[{type:void 0,decorators:[{type:e.Inject,args:[u]}]},{type:g.HttpClient}]},f);function f(t,e){this._opts=t,this._httpClient=e,this._status=new v.BehaviorSubject({status:"initializing"}),this.status=this._status.asObservable(),this._timerSub=v.Subscription.EMPTY,this._syncing=!1,this._remoteCheckpointKey="gngt_remote_sync_checkpoint",this._localCheckpointKey="gngt_local_sync_checkpoint",this._localSyncNumber="gngt_local_sync_number",this._localSyncEntryPrefix="gngt_local_sync_entry_",this._relationalModelIdx={index:{name:"relational_model_idx",fields:["table_name","object_id"]}},this._databaseInit=new v.BehaviorSubject(!1),null==this._opts.syncInterval&&(this._opts.syncInterval=3e5),null==this._opts.changesBatchSize&&(this._opts.changesBatchSize=50),this._syncUrl=""+this._opts.baseUrl+(this._opts.changesPath||"changes"),this._changesUrl=""+this._opts.baseUrl+(this._opts.docsPath||"docs"),this._initLocalDatabase(),this._databaseIsInit=this._databaseInit.pipe(j.filter(function(t){return t}))}var _=(h.prototype.intercept=function(n,t){var r=this;return t.handle(n).pipe(j.catchError(function(t){if(0===t.status){var e=r._checkOfflineRequest(n);if(0<e.length)return r._doOfflineRequest(n,e[0],t)}return v.throwError(t)}))},h.prototype._doOfflineRequest=function(e,t,n){var r=e.method.toLowerCase(),o=this._analyzeRequestUrl(e,t),i=o.exactMatch,a=o.relativeUrl;if(i){if("get"===r){var c=e.params.get("limit"),s=e.params.get("start"),u=e.params.get("sort"),p=e.params.get("fields"),l=e.params.get("joins");return this._syncService.list(t.tableName,{limit:c,start:s,sort:u,fields:p,joins:l}).pipe(j.catchError(function(t){return v.throwError(n)}),j.map(function(t){return new g.HttpResponse({status:200,statusText:"OK",url:e.url,body:t})}))}if("post"===r){var d=e.body;return this._syncService.create(t.tableName,d).pipe(j.catchError(function(t){return v.throwError(n)}),j.map(function(t){return new g.HttpResponse({status:201,statusText:"OK",url:e.url,body:t})}))}}else if(1===a.length){var f=a[0];if("delete_all"===f){var _=e.body.ids;if(null!=_&&_ instanceof Array&&0<_.length)return this._syncService.deleteAll(t.tableName,_).pipe(j.catchError(function(t){return v.throwError(n)}),j.map(function(t){return new g.HttpResponse({status:200,statusText:"OK",url:e.url,body:t})}))}else{if("query"===f){var h=e.body;return this._syncService.query(t.tableName,h).pipe(j.catchError(function(t){return v.throwError(n)}),j.map(function(t){return new g.HttpResponse({status:200,statusText:"OK",url:e.url,body:t})}))}var y=parseInt(f,10);if(!isNaN(y)&&0<y){var b=null,m=200;if(d=e.body,"get"===r?(b=this._syncService.get(t.tableName,{id:y}),m=201):"patch"===r||"put"===r?b=this._syncService.update(t.tableName,y,d):"delete"===r&&(b=this._syncService.delete(t.tableName,y)),null!=b)return b.pipe(j.catchError(function(t){return v.throwError(n)}),j.map(function(t){return new g.HttpResponse({status:m,statusText:"OK",url:e.url,body:t})}))}}}return v.throwError(n)},h.prototype._analyzeRequestUrl=function(t,e){var n=new RegExp("^"+e.endpoint+"$").test(t.url);if(n)return{exactMatch:n,relativeUrl:[]};var r=e.endpoint.split(/\/+/);return{exactMatch:n,relativeUrl:t.url.split(/\/+/).slice(r.length)}},h.prototype._checkOfflineRequest=function(e){return s.filter(function(t){return new RegExp("^"+t.endpoint).test(e.url)})},h.decorators=[{type:e.Injectable}],h.ctorParameters=function(){return[{type:d}]},h);function h(t){this._syncService=t}var y=(b.forRoot=function(t){return{ngModule:b,providers:[d,{provide:g.HTTP_INTERCEPTORS,useClass:_,multi:!0},{provide:u,useValue:t}]}},b.decorators=[{type:e.NgModule,args:[{}]}],b);function b(){}t.OfflineInterceptor=_,t.SYNC_OPTIONS=u,t.SyncModule=y,t.SyncService=d,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=core-sync.umd.min.js.map
