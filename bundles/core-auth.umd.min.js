/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@ngrx/store"),require("@angular/core"),require("url-parse"),require("@angular/common/http"),require("rxjs/operators"),require("@angular/forms"),require("rxjs"),require("@gngt/core/common"),require("@ngrx/effects"),require("@angular/router"),require("@ngx-translate/core")):"function"==typeof define&&define.amd?define("@gngt/core/auth",["exports","@ngrx/store","@angular/core","url-parse","@angular/common/http","rxjs/operators","@angular/forms","rxjs","@gngt/core/common","@ngrx/effects","@angular/router","@ngx-translate/core"],t):t(((e=e||self).gngt=e.gngt||{},e.gngt.core=e.gngt.core||{},e.gngt.core.auth={}),e.ngrx.store,e.ng.core,e.urlParse,e.ng.common.http,e.rxjs.operators,e.ng.forms,e.rxjs,e.gngt.core.common,e.ngrx.effects,e.ng.router,e.ngxt.core)}(this,function(e,r,o,n,t,u,i,a,s,p,c,f){"use strict";function l(){this.type=g.LogoutConfirmation}var h=function(){return(h=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},g={Init:"[Auth] Init",InitUser:"[Auth] Init user",InitUserComplete:"[Auth] Init user complete",InitComplete:"[Auth] Init complete",Logout:"[Auth] Logout",LogoutConfirmation:"[Auth] Logout Confirmation",LogoutConfirmationDismiss:"[Auth] Logout Confirmation Dismiss"},d=function(){this.type=g.Init},y=function(){this.type=g.InitUser},m=function(e){this.payload=e,this.type=g.InitUserComplete},_=function(){this.type=g.InitComplete},v=function(){this.type=g.Logout},k=function(){this.type=g.LogoutConfirmationDismiss},S=Object.freeze({AuthActionTypes:g,Init:d,InitUser:y,InitUserComplete:m,InitComplete:_,Logout:v,LogoutConfirmation:l,LogoutConfirmationDismiss:k}),I={LoginSuccess:"[Auth/API] Login Success",LoginFailure:"[Auth/API] Login Failure",LoginRedirect:"[Auth/API] Login Redirect",RefreshToken:"[Auth/API] Refresh token"},w=function(e){this.payload=e,this.type=I.LoginSuccess},T=function(e){this.payload=e,this.type=I.LoginFailure},j=function(){this.type=I.LoginRedirect},b=function(e){this.payload=e,this.type=I.RefreshToken},A=Object.freeze({AuthApiActionTypes:I,LoginSuccess:w,LoginFailure:T,LoginRedirect:j,RefreshToken:b}),E={init:!1,user:null,token:null};function x(e,t){switch(void 0===e&&(e=E),t.type){case I.LoginSuccess:return h({},e,{user:t.payload.user});case g.Logout:return E;case g.InitUserComplete:return h({},e,{init:!0,user:t.payload.user});case g.InitComplete:return h({},e,{init:!0});default:return e}}var L="[Login Page] Login",C=function(e){this.payload=e,this.type=L},U={error:null,pending:!1};function P(e,t){switch(void 0===e&&(e=U),t.type){case L:return h({},e,{error:null,pending:!0});case I.LoginSuccess:return h({},e,{error:null,pending:!1});case I.LoginFailure:return h({},e,{error:t.payload.error,pending:!1});default:return e}}function D(e){return e.status}function O(e){return null!=e}function R(e){return e.loginPage}var G={status:x,loginPage:P},$=r.createFeatureSelector("auth"),H=r.createSelector($,D),F=r.createSelector(H,function(e){return e.init}),M=r.createSelector(H,function(e){return e.user}),q=r.createSelector(M,O),N=r.createSelector($,R),W=r.createSelector(N,function(e){return e.error}),B=r.createSelector(N,function(e){return e.pending}),J=Object.freeze({AuthState:function(){},State:function(){},reducers:G,selectAuthState:$,selectAuthStatusState:H,getInit:F,getUser:M,getLoggedIn:q,selectLoginPageState:N,getLoginPageError:W,getLoginPagePending:B,"ɵ0":D,"ɵ1":O,"ɵ2":R}),z=new o.InjectionToken("AUTH_OPTIONS",{providedIn:"root",factory:function(){return{loginUrl:"/login",logoutUrl:"/logout",refreshTokenUrl:"/refresh_token",meUrl:"/me"}}}),K=new o.InjectionToken("JWT_OPTIONS",{providedIn:"root",factory:function(){return{}}}),V=(Y.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this._b64DecodeUnicode(t)},Y.prototype._b64decode=function(e){var t="";if((e=String(e).replace(/=+$/,"")).length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var r=0,n=void 0,o=void 0,i=0;o=e.charAt(i++);~o&&(n=r%4?64*n+o:o,r++%4)&&(t+=String.fromCharCode(255&n>>(-2*r&6))))o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return t},Y.prototype._b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(this._b64decode(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))},Y.prototype.decodeToken=function(e){if(void 0===e&&(e=this.tokenGetter()),null===e)return null;var t=e.split(".");if(3!==t.length)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token.");return JSON.parse(r)},Y.prototype.getTokenExpirationDate=function(e){var t;if(void 0===e&&(e=this.tokenGetter()),!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},Y.prototype.isTokenExpired=function(e,t){if(void 0===e&&(e=this.tokenGetter()),null===e||""===e)return!0;var r=this.getTokenExpirationDate(e);return t=t||0,null===r||!(r.valueOf()>(new Date).valueOf()+1e3*t)},Y.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],Y.ctorParameters=function(){return[{type:void 0,decorators:[{type:o.Inject,args:[K]}]}]},Y.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new Y(o.ɵɵinject(K))},token:Y,providedIn:"root"}),Y);function Y(e){this.tokenGetter=e&&e.tokenGetter?e.tokenGetter:function(){return null},this.tokenSetter=e&&e.tokenSetter?e.tokenSetter:function(){return null},this.refreshTokenGetter=e&&e.refreshTokenGetter?e.refreshTokenGetter:function(){return null},this.refreshTokenSetter=e&&e.refreshTokenSetter?e.refreshTokenSetter:function(){return null}}var Q=(X.prototype.isWhitelistedDomain=function(e){var t=new n(e.url);return null===t.host||-1<this.whitelistedDomains.findIndex(function(e){return"string"==typeof e?e===t.host:e instanceof RegExp&&e.test(t.host)})},X.prototype.isBlacklistedRoute=function(e){var t=e.url;return-1<this.blacklistedRoutes.findIndex(function(e){return"string"==typeof e?e===t:e instanceof RegExp&&e.test(t)})},X.prototype.handleInterception=function(e,t,r){var n,o=!1;if(!e&&this.throwNoTokenError)throw new Error("Could not get token from tokenGetter function.");return this.skipWhenExpired&&(o=!e||this.jwtHelper.isTokenExpired(e)),e&&o&&this.skipWhenExpired?t=t.clone():e&&this.isWhitelistedDomain(t)&&!this.isBlacklistedRoute(t)&&(t=t.clone({setHeaders:(n={},n[this.headerName]=""+this.authScheme+e,n)})),r.handle(t)},X.prototype.intercept=function(e,t){var r=this.tokenGetter?this.tokenGetter():null;return this.handleInterception(r,e,t)},X.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],X.ctorParameters=function(){return[{type:void 0,decorators:[{type:o.Inject,args:[K]}]},{type:V}]},X.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new X(o.ɵɵinject(K),o.ɵɵinject(V))},token:X,providedIn:"root"}),X);function X(e,t){this.jwtHelper=t,this.tokenGetter=e.tokenGetter,this.headerName=e.headerName||"Authorization",this.authScheme=e.authScheme||""===e.authScheme?e.authScheme:"Bearer ",this.whitelistedDomains=e.whitelistedDomains||[],this.blacklistedRoutes=e.blacklistedRoutes||[],this.throwNoTokenError=e.throwNoTokenError||!1,this.skipWhenExpired=e.skipWhenExpired||!1}var Z=(ee.prototype.login=function(e){var t=this._config.loginUrl;return this._http.post(t,e)},ee.prototype.logout=function(){var e=this._config.logoutUrl;return this._http.post(e,{})},ee.prototype.refreshToken=function(e){var t=this._config.refreshTokenUrl;return this._http.post(t,{refresh_token:e})},ee.prototype.getCurrentUser=function(){var e=this._config.meUrl;return this._http.get(e)},ee.prototype.getLoggedInUser=function(){return this._config.loggedInUserGetter?this._config.loggedInUserGetter():null},ee.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],ee.ctorParameters=function(){return[{type:t.HttpClient},{type:void 0,decorators:[{type:o.Inject,args:[z]}]}]},ee.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new ee(o.ɵɵinject(t.HttpClient),o.ɵɵinject(z))},token:ee,providedIn:"root"}),ee);function ee(e,t){this._http=e,this._config=t}var te=(re.prototype.canActivate=function(){return this._guard()},re.prototype.canActivateChild=function(e,t){return this._guard()},re.prototype._guard=function(){var t=this;return this._store.pipe(r.select(F),u.filter(function(e){return e}),u.concatMap(function(){return t._store.pipe(r.select(q))}),u.map(function(e){return!!e||(t._store.dispatch(new j),!1)}),u.take(1))},re.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],re.ctorParameters=function(){return[{type:r.Store}]},re.ngInjectableDef=o.ɵɵdefineInjectable({factory:function(){return new re(o.ɵɵinject(r.Store))},token:re,providedIn:"root"}),re);function re(e){this._store=e}function ne(){}var oe=(Object.defineProperty(ie.prototype,"disabled",{get:function(){return this._disabled},set:function(e){this._disabled=s.forceBooleanProp(e),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),ie.prototype.login=function(){this._loginEvt.next()},ie.prototype.ngOnDestroy=function(){this._loginSub.unsubscribe(),this._loginEvt.complete()},ie);function ie(e,t,r){var n=this;this._cdr=r,this._loginEvt=new o.EventEmitter,this._loginSub=a.Subscription.EMPTY,this.loginForm=e.group({username:[null,[i.Validators.required]],password:[null,[i.Validators.required]]}),this.valid=this.loginForm.valueChanges.pipe(u.map(function(){return n.loginForm.valid})),this._loginSub=this._loginEvt.subscribe(function(){t.dispatch(new C({credentials:n.loginForm.value}))})}var se=(ce.prototype.ngrxOnInitEffects=function(){return new d},ce.prototype._getRefreshTokenAction=function(e){var t=this._jwtHelperService.tokenGetter(),r=this._jwtHelperService.getTokenExpirationDate(t)||new Date,n=Math.max(0,Math.round(.8*(r.getTime()-(new Date).getTime())));return new b({refreshDelay:n,fromInit:e})},ce.prototype._getScopesFromToken=function(t){return(this._config.scopesPath||["scopes"]).forEach(function(e){return t=t[e]}),t},ce.decorators=[{type:o.Injectable}],ce.ctorParameters=function(){return[{type:p.Actions},{type:Z},{type:V},{type:ne},{type:c.Router},{type:f.TranslateService},{type:void 0,decorators:[{type:o.Inject,args:[z]}]}]},ce);function ce(e,t,r,n,o,i,s){var c=this;this._actions$=e,this._authService=t,this._jwtHelperService=r,this._userInteractionsService=n,this._router=o,this._ts=i,this._config=s,this.initUser$=p.createEffect(function(){return c._actions$.pipe(p.ofType(g.InitUser),u.exhaustMap(function(){return c._authService.getCurrentUser().pipe(u.catchError(function(e){return a.of(null!=c._config.meGetter?c._config.meGetter():null)}))}),u.map(function(e){return null!=c._config.meSetter&&c._config.meSetter(e),new m({user:e})}))}),this.initUserComplete$=p.createEffect(function(){return c._actions$.pipe(p.ofType(g.InitUserComplete),u.map(function(){return new _}))}),this.login$=p.createEffect(function(){return c._actions$.pipe(p.ofType(L),u.map(function(e){return e.payload.credentials}),u.exhaustMap(function(e){return c._authService.login(e).pipe(u.map(function(e){return new w(e)}),u.catchError(function(e){var t=[];return 0!==e.status&&e.error.message?t.push(e.error.message):t.push("Connection problem. Please try again"),a.zip.apply(void 0,t.map(function(e){return c._ts.get(e)})).pipe(u.map(function(e){return new T({error:e})}))}))}))}),this.loginSuccess$=p.createEffect(function(){return c._actions$.pipe(p.ofType(I.LoginSuccess),u.tap(function(e){var t=e.payload,r=c._config.tokenKey||"access_token",n=c._config.refreshTokenKey||"refresh_token";c._jwtHelperService.tokenSetter(t[r]),c._jwtHelperService.refreshTokenSetter(t[n]),c._config.loggedInUserSetter&&c._config.loggedInUserSetter(t.user_id),c._router.navigate(["/"])}),u.mergeMap(function(e){return[c._getRefreshTokenAction(),new m({user:e.payload.user})]}))}),this.loginFailure$=p.createEffect(function(){return c._actions$.pipe(p.ofType(I.LoginFailure),u.tap(function(e){c._userInteractionsService.showLoginError(e.payload.error.join("\n"))}))},{dispatch:!1}),this.refreshToken$=p.createEffect(function(){return c._actions$.pipe(p.ofType(I.RefreshToken),u.delayWhen(function(e){return a.timer(e.payload.refreshDelay)}),u.exhaustMap(function(n){return c._authService.refreshToken(c._jwtHelperService.refreshTokenGetter()||"").pipe(u.switchMap(function(e){var t=[],r=c._config.tokenKey||"access_token";return c._jwtHelperService.tokenSetter(e[r]),n.payload.fromInit&&t.push(new y),t.push(c._getRefreshTokenAction()),t}),u.catchError(function(){return a.of(new _)}))}))}),this.loginRedirect$=p.createEffect(function(){return c._actions$.pipe(p.ofType(I.LoginRedirect,g.Logout),u.tap(function(e){c._router.navigate(["/login"])}))},{dispatch:!1}),this.logoutConfirmation$=p.createEffect(function(){return c._actions$.pipe(p.ofType(g.LogoutConfirmation),u.exhaustMap(function(){return c._userInteractionsService.askLogoutConfirm()}),u.map(function(e){return e?new v:new k}))}),this.init$=p.createEffect(function(){return c._actions$.pipe(p.ofType(g.Init),u.switchMap(function(){var t=[],e=c._jwtHelperService.tokenGetter();if(e)try{if(c._jwtHelperService.isTokenExpired(e))t.push(new b({refreshDelay:0,fromInit:!0}));else{var r=c._jwtHelperService.decodeToken(e),n=c._config.disableScopes?[]:c._getScopesFromToken(r);(c._config.disableScopes||-1<n.indexOf("admin"))&&(t.push(new y),t.push(c._getRefreshTokenAction()))}}catch(e){t.push(new _)}else t.push(new _);return t}))})}var ue=(ae.decorators=[{type:o.NgModule,args:[{imports:[r.StoreModule.forFeature("auth",G),p.EffectsModule.forFeature([se])],providers:[se,te,Z,V,Q]}]}],ae);function ae(){}e.AUTH_OPTIONS=z,e.AuthActions=S,e.AuthApiActions=A,e.AuthGuard=te,e.AuthModule=ue,e.AuthService=Z,e.AuthUserInteractionsService=ne,e.JWT_OPTIONS=K,e.JwtHelperService=V,e.JwtInterceptor=Q,e.LoginComponent=oe,e.reducers=J,e.ɵb=G,e.ɵc=x,e.ɵd=P,e.ɵe=se,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-auth.umd.min.js.map
