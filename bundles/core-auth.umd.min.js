/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@ngrx/store"),require("@angular/core"),require("url-parse"),require("@angular/common/http"),require("rxjs/operators"),require("@angular/forms"),require("rxjs"),require("@gngt/core/common"),require("@ngrx/effects"),require("@angular/router"),require("@ngx-translate/core")):"function"==typeof define&&define.amd?define("@gngt/core/auth",["exports","@ngrx/store","@angular/core","url-parse","@angular/common/http","rxjs/operators","@angular/forms","rxjs","@gngt/core/common","@ngrx/effects","@angular/router","@ngx-translate/core"],t):t(((e=e||self).dewco=e.dewco||{},e.dewco.core=e.dewco.core||{},e.dewco.core.auth={}),e.ngrx.store,e.ng.core,e.urlParse,e.ng.common.http,e.rxjs.operators,e.ng.forms,e.rxjs,e.gngt.core.common,e.ngrx.effects,e.ng.router,e.ngxt.core)}(this,function(e,r,o,n,t,u,i,a,s,p,c,f){"use strict";var l=function(){return(l=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function h(e,t,r,n){var o,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;0<=c;c--)(o=e[c])&&(s=(i<3?o(s):3<i?o(t,r,s):o(t,r))||s);return 3<i&&s&&Object.defineProperty(t,r,s),s}function d(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var g={InitUser:"[Auth] Init user",InitUserComplete:"[Auth] Init user complete",InitComplete:"[Auth] Init complete",Logout:"[Auth] Logout",LogoutConfirmation:"[Auth] Logout Confirmation",LogoutConfirmationDismiss:"[Auth] Logout Confirmation Dismiss"},y=function(){this.type=g.InitUser},m=function(e){this.payload=e,this.type=g.InitUserComplete},v=function(){this.type=g.InitComplete},k=function(){this.type=g.Logout},S=function(){this.type=g.LogoutConfirmation},I=function(){this.type=g.LogoutConfirmationDismiss},w=Object.freeze({AuthActionTypes:g,InitUser:y,InitUserComplete:m,InitComplete:v,Logout:k,LogoutConfirmation:S,LogoutConfirmationDismiss:I}),j={LoginSuccess:"[Auth/API] Login Success",LoginFailure:"[Auth/API] Login Failure",LoginRedirect:"[Auth/API] Login Redirect",RefreshToken:"[Auth/API] Refresh token"},b=function(e){this.payload=e,this.type=j.LoginSuccess},T=function(e){this.payload=e,this.type=j.LoginFailure},A=function(){this.type=j.LoginRedirect},_=function(e){this.payload=e,this.type=j.RefreshToken},E=Object.freeze({AuthApiActionTypes:j,LoginSuccess:b,LoginFailure:T,LoginRedirect:A,RefreshToken:_}),L={init:!1,user:null,token:null};function x(e,t){switch(void 0===e&&(e=L),t.type){case j.LoginSuccess:return l({},e,{user:t.payload.user});case g.Logout:return L;case g.InitUserComplete:return l({},e,{init:!0,user:t.payload.user});case g.InitComplete:return l({},e,{init:!0});default:return e}}var C="[Login Page] Login",U=function(e){this.payload=e,this.type=C},O={error:null,pending:!1};function P(e,t){switch(void 0===e&&(e=O),t.type){case C:return l({},e,{error:null,pending:!0});case j.LoginSuccess:return l({},e,{error:null,pending:!1});case j.LoginFailure:return l({},e,{error:t.payload.error,pending:!1});default:return e}}var R={status:x,loginPage:P},D=r.createFeatureSelector("auth"),$=r.createSelector(D,function(e){return e.status}),G=r.createSelector($,function(e){return e.init}),F=r.createSelector($,function(e){return e.user}),H=r.createSelector(F,function(e){return null!=e}),M=r.createSelector(D,function(e){return e.loginPage}),q=r.createSelector(M,function(e){return e.error}),N=r.createSelector(M,function(e){return e.pending}),W=Object.freeze({AuthState:function(){},State:function(){},reducers:R,selectAuthState:D,selectAuthStatusState:$,getInit:G,getUser:F,getLoggedIn:H,selectLoginPageState:M,getLoginPageError:q,getLoginPagePending:N}),B=new o.InjectionToken("AUTH_OPTIONS",{providedIn:"root",factory:function(){return{loginUrl:"/login",logoutUrl:"/logout",refreshTokenUrl:"/refresh_token",meUrl:"/me"}}}),J=new o.InjectionToken("JWT_OPTIONS",{providedIn:"root",factory:function(){return{}}}),z=function(){function e(e){this.tokenGetter=e&&e.tokenGetter?e.tokenGetter:function(){return null},this.tokenSetter=e&&e.tokenSetter?e.tokenSetter:function(){return null},this.refreshTokenGetter=e&&e.refreshTokenGetter?e.refreshTokenGetter:function(){return null},this.refreshTokenSetter=e&&e.refreshTokenSetter?e.refreshTokenSetter:function(){return null}}return e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)},e.prototype.b64decode=function(e){var t="";if((e=String(e).replace(/=+$/,"")).length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var r=0,n=void 0,o=void 0,i=0;o=e.charAt(i++);~o&&(n=r%4?64*n+o:o,r++%4)?t+=String.fromCharCode(255&n>>(-2*r&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return t},e.prototype.b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(this.b64decode(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))},e.prototype.decodeToken=function(e){if(void 0===e&&(e=this.tokenGetter()),null===e)return null;var t=e.split(".");if(3!==t.length)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token.");return JSON.parse(r)},e.prototype.getTokenExpirationDate=function(e){var t;if(void 0===e&&(e=this.tokenGetter()),!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},e.prototype.isTokenExpired=function(e,t){if(void 0===e&&(e=this.tokenGetter()),null===e||""===e)return!0;var r=this.getTokenExpirationDate(e);return t=t||0,null===r||!(r.valueOf()>(new Date).valueOf()+1e3*t)},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:o.Inject,args:[J]}]}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(J))},token:e,providedIn:"root"}),e}(),K=function(){function e(e,t){this.jwtHelper=t,this.tokenGetter=e.tokenGetter,this.headerName=e.headerName||"Authorization",this.authScheme=e.authScheme||""===e.authScheme?e.authScheme:"Bearer ",this.whitelistedDomains=e.whitelistedDomains||[],this.blacklistedRoutes=e.blacklistedRoutes||[],this.throwNoTokenError=e.throwNoTokenError||!1,this.skipWhenExpired=e.skipWhenExpired||!1}return e.prototype.isWhitelistedDomain=function(e){var t=new n(e.url);return null===t.host||-1<this.whitelistedDomains.findIndex(function(e){return"string"==typeof e?e===t.host:e instanceof RegExp&&e.test(t.host)})},e.prototype.isBlacklistedRoute=function(e){var t=e.url;return-1<this.blacklistedRoutes.findIndex(function(e){return"string"==typeof e?e===t:e instanceof RegExp&&e.test(t)})},e.prototype.handleInterception=function(e,t,r){var n,o=!1;if(!e&&this.throwNoTokenError)throw new Error("Could not get token from tokenGetter function.");return this.skipWhenExpired&&(o=!e||this.jwtHelper.isTokenExpired(e)),e&&o&&this.skipWhenExpired?t=t.clone():e&&this.isWhitelistedDomain(t)&&!this.isBlacklistedRoute(t)&&(t=t.clone({setHeaders:(n={},n[this.headerName]=""+this.authScheme+e,n)})),r.handle(t)},e.prototype.intercept=function(e,t){var r=this.tokenGetter?this.tokenGetter():null;return this.handleInterception(r,e,t)},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:o.Inject,args:[J]}]},{type:z}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(J),o.inject(z))},token:e,providedIn:"root"}),e}(),V=function(){function e(e,t){this._http=e,this._config=t}return e.prototype.login=function(e){var t=this._config.loginUrl;return this._http.post(t,e)},e.prototype.logout=function(){var e=this._config.logoutUrl;return this._http.post(e,{})},e.prototype.refreshToken=function(e){var t=this._config.refreshTokenUrl;return this._http.post(t,{refresh_token:e})},e.prototype.getCurrentUser=function(){var e=this._config.meUrl;return this._http.get(e)},e.prototype.getLoggedInUser=function(){return this._config.loggedInUserGetter?this._config.loggedInUserGetter():null},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:t.HttpClient},{type:void 0,decorators:[{type:o.Inject,args:[B]}]}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(t.HttpClient),o.inject(B))},token:e,providedIn:"root"}),e}(),Y=function(){function e(e){this.store=e}return e.prototype.canActivate=function(){return this._guard()},e.prototype.canActivateChild=function(e,t){return this._guard()},e.prototype._guard=function(){var t=this;return this.store.pipe(r.select(G),u.filter(function(e){return e}),u.concatMap(function(){return t.store.pipe(r.select(H))}),u.map(function(e){return!!e||(t.store.dispatch(new A),!1)}),u.take(1))},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.Store}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(r.Store))},token:e,providedIn:"root"}),e}(),Q=function(){},X=function(){function e(e,t,r){var n=this;this._cdr=r,this._loginEvt=new o.EventEmitter,this._loginSub=a.Subscription.EMPTY,this.loginForm=e.group({username:[null,[i.Validators.required]],password:[null,[i.Validators.required]]}),this.valid=this.loginForm.valueChanges.pipe(u.map(function(){return n.loginForm.valid})),this._loginSub=this._loginEvt.subscribe(function(){t.dispatch(new U({credentials:n.loginForm.value}))})}return Object.defineProperty(e.prototype,"disabled",{get:function(){return this._disabled},set:function(e){this._disabled=s.forceBooleanProp(e),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),e.prototype.login=function(){this._loginEvt.next()},e.prototype.ngOnDestroy=function(){this._loginSub.unsubscribe(),this._loginEvt.complete()},e}(),Z=function(){function e(e,t,r,n,o,i,s){var c=this;this.actions$=e,this.authService=t,this.jwtHelperService=r,this.userInteractionsService=n,this.router=o,this.ts=i,this.config=s,this.initUser$=this.actions$.pipe(p.ofType(g.InitUser),u.exhaustMap(function(){return c.authService.getCurrentUser().pipe(u.catchError(function(e){return a.of(null)}))}),u.map(function(e){return new m({user:e})})),this.initUserComplete$=this.actions$.pipe(p.ofType(g.InitUserComplete),u.map(function(){return new v})),this.login$=this.actions$.pipe(p.ofType(C),u.map(function(e){return e.payload.credentials}),u.exhaustMap(function(e){return c.authService.login(e).pipe(u.map(function(e){return new b(e)}),u.catchError(function(e){var t=[];return 0!==e.status&&e.error.message?t.push(e.error.message):t.push("Connection problem. Please try again"),a.zip.apply(void 0,t.map(function(e){return c.ts.get(e)})).pipe(u.map(function(e){return new T({error:e})}))}))})),this.loginSuccess$=this.actions$.pipe(p.ofType(j.LoginSuccess),u.tap(function(e){var t=e.payload,r=c.config.tokenKey||"access_token",n=c.config.refreshTokenKey||"refresh_token";c.jwtHelperService.tokenSetter(t[r]),c.jwtHelperService.refreshTokenSetter(t[n]),c.config.loggedInUserSetter&&c.config.loggedInUserSetter(t.user_id),c.router.navigate(["/"])}),u.map(function(){return c._getRefreshTokenAction()})),this.loginFailure$=this.actions$.pipe(p.ofType(j.LoginFailure),u.tap(function(e){c.userInteractionsService.showLoginError(e.payload.error.join("\n"))})),this.refreshToken$=this.actions$.pipe(p.ofType(j.RefreshToken),u.delayWhen(function(e){return a.timer(e.payload.refreshDelay)}),u.exhaustMap(function(n){return c.authService.refreshToken(c.jwtHelperService.refreshTokenGetter()||"").pipe(u.switchMap(function(e){var t=[],r=c.config.tokenKey||"access_token";return c.jwtHelperService.tokenSetter(e[r]),n.payload.fromInit&&t.push(new y),t.push(c._getRefreshTokenAction()),t}),u.catchError(function(){return a.of(new v)}))})),this.loginRedirect$=this.actions$.pipe(p.ofType(j.LoginRedirect,g.Logout),u.tap(function(e){c.router.navigate(["/login"])})),this.logoutConfirmation$=this.actions$.pipe(p.ofType(g.LogoutConfirmation),u.exhaustMap(function(){return c.userInteractionsService.askLogoutConfirm()}),u.map(function(e){return e?new k:new I})),this.init$=a.defer(function(){return a.of(null)}).pipe(u.switchMap(function(){var t=[],e=c.jwtHelperService.tokenGetter();if(e)try{if(c.jwtHelperService.isTokenExpired(e))t.push(new _({refreshDelay:0,fromInit:!0}));else{var r=c.jwtHelperService.decodeToken(e),n=c.config.disableScopes?[]:c._getScopesFromToken(r);(c.config.disableScopes||-1<n.indexOf("admin"))&&(t.push(new y),t.push(c._getRefreshTokenAction()))}}catch(e){t.push(new v)}else t.push(new v);return t}))}return e.prototype._getRefreshTokenAction=function(e){var t=this.jwtHelperService.tokenGetter(),r=this.jwtHelperService.getTokenExpirationDate(t)||new Date,n=Math.max(0,Math.round(.8*(r.getTime()-(new Date).getTime())));return new _({refreshDelay:n,fromInit:e})},e.prototype._getScopesFromToken=function(t){return(this.config.scopesPath||["scopes"]).forEach(function(e){return t=t[e]}),t},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:p.Actions},{type:V},{type:z},{type:Q},{type:c.Router},{type:f.TranslateService},{type:void 0,decorators:[{type:o.Inject,args:[B]}]}]},h([p.Effect(),d("design:type",Object)],e.prototype,"initUser$",void 0),h([p.Effect(),d("design:type",Object)],e.prototype,"initUserComplete$",void 0),h([p.Effect(),d("design:type",Object)],e.prototype,"login$",void 0),h([p.Effect(),d("design:type",Object)],e.prototype,"loginSuccess$",void 0),h([p.Effect({dispatch:!1}),d("design:type",Object)],e.prototype,"loginFailure$",void 0),h([p.Effect(),d("design:type",Object)],e.prototype,"refreshToken$",void 0),h([p.Effect({dispatch:!1}),d("design:type",Object)],e.prototype,"loginRedirect$",void 0),h([p.Effect(),d("design:type",Object)],e.prototype,"logoutConfirmation$",void 0),h([p.Effect(),d("design:type",Object)],e.prototype,"init$",void 0),e}(),ee=function(){function e(){}return e.decorators=[{type:o.NgModule,args:[{imports:[r.StoreModule.forFeature("auth",R),p.EffectsModule.forFeature([Z])],providers:[Z,Y,V,z,K]}]}],e}();e.AUTH_OPTIONS=B,e.AuthActions=w,e.AuthApiActions=E,e.AuthGuard=Y,e.AuthModule=ee,e.AuthService=V,e.AuthUserInteractionsService=Q,e.JWT_OPTIONS=J,e.JwtHelperService=z,e.JwtInterceptor=K,e.LoginComponent=X,e.reducers=W,e.ɵb=R,e.ɵc=x,e.ɵd=P,e.ɵe=Z,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-auth.umd.min.js.map
