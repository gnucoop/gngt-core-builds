/**
 * @license
 * Copyright (C) 2018 Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@ngrx/store"),require("@angular/core"),require("url-parse"),require("@angular/common/http"),require("rxjs/operators"),require("@angular/forms"),require("rxjs"),require("@gngt/core/common"),require("@ngrx/effects"),require("@angular/router"),require("@ngx-translate/core")):"function"==typeof define&&define.amd?define("@gngt/core/auth",["exports","@ngrx/store","@angular/core","url-parse","@angular/common/http","rxjs/operators","@angular/forms","rxjs","@gngt/core/common","@ngrx/effects","@angular/router","@ngx-translate/core"],t):t(((e=e||self).dewco=e.dewco||{},e.dewco.core=e.dewco.core||{},e.dewco.core.auth={}),e.ngrx.store,e.ng.core,e.urlParse,e.ng.common.http,e.rxjs.operators,e.ng.forms,e.rxjs,e.gngt.core.common,e.ngrx.effects,e.ng.router,e.ngxt.core)}(this,function(e,r,o,n,t,u,i,a,c,p,s,f){"use strict";var h=function(){return(h=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function l(e,t,r,n){var o,i=arguments.length,c=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(c=(i<3?o(c):3<i?o(t,r,c):o(t,r))||c);return 3<i&&c&&Object.defineProperty(t,r,c),c}function d(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var g="[Auth/API] Login Success",y="[Auth/API] Login Failure",v="[Auth/API] Login Redirect",m="[Auth/API] Refresh token",k=function(e){this.payload=e,this.type=g},w=function(e){this.payload=e,this.type=y},S=function(){this.type=v},j=function(e){this.payload=e,this.type=m},b="[Auth] Init user",T="[Auth] Init user complete",I="[Auth] Init complete",E="[Auth] Logout",x="[Auth] Logout Confirmation",_="[Auth] Logout Confirmation Dismiss",A=function(){this.type=b},O=function(e){this.payload=e,this.type=T},P=function(){this.type=I},$=function(){this.type=E},D=function(){this.type=_},C={init:!1,user:null,token:null};function R(e,t){switch(void 0===e&&(e=C),t.type){case g:return h({},e,{user:t.payload.user});case E:return C;case T:return h({},e,{init:!0,user:t.payload.user});case I:return h({},e,{init:!0});default:return e}}var U="[Login Page] Login",G=function(e){this.payload=e,this.type=U},H={error:null,pending:!1};function L(e,t){switch(void 0===e&&(e=H),t.type){case U:return h({},e,{error:null,pending:!0});case g:return h({},e,{error:null,pending:!1});case y:return h({},e,{error:t.payload.error,pending:!1});default:return e}}var M={status:R,loginPage:L},q=r.createFeatureSelector("auth"),F=r.createSelector(q,function(e){return e.status}),N=r.createSelector(F,function(e){return e.init}),W=r.createSelector(F,function(e){return e.user}),B=r.createSelector(W,function(e){return null!=e}),J=r.createSelector(q,function(e){return e.loginPage}),z=r.createSelector(J,function(e){return e.error}),K=r.createSelector(J,function(e){return e.pending}),V=Object.freeze({AuthState:function(){},State:function(){},reducers:M,selectAuthState:q,selectAuthStatusState:F,getInit:N,getUser:W,getLoggedIn:B,selectLoginPageState:J,getLoginPageError:z,getLoginPagePending:K}),Y=new o.InjectionToken("AUTH_OPTIONS",{providedIn:"root",factory:function(){return{loginUrl:"/login",logoutUrl:"/logout",refreshTokenUrl:"/refresh_token",meUrl:"/me"}}}),Q=new o.InjectionToken("JWT_OPTIONS",{providedIn:"root",factory:function(){return{}}}),X=function(){function e(e){this.tokenGetter=e&&e.tokenGetter?e.tokenGetter:function(){return null},this.tokenSetter=e&&e.tokenSetter?e.tokenSetter:function(){return null},this.refreshTokenGetter=e&&e.refreshTokenGetter?e.refreshTokenGetter:function(){return null},this.refreshTokenSetter=e&&e.refreshTokenSetter?e.refreshTokenSetter:function(){return null}}return e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)},e.prototype.b64decode=function(e){var t="";if((e=String(e).replace(/=+$/,"")).length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var r=0,n=void 0,o=void 0,i=0;o=e.charAt(i++);~o&&(n=r%4?64*n+o:o,r++%4)?t+=String.fromCharCode(255&n>>(-2*r&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return t},e.prototype.b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(this.b64decode(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))},e.prototype.decodeToken=function(e){if(void 0===e&&(e=this.tokenGetter()),null===e)return null;var t=e.split(".");if(3!==t.length)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token.");return JSON.parse(r)},e.prototype.getTokenExpirationDate=function(e){var t;if(void 0===e&&(e=this.tokenGetter()),!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},e.prototype.isTokenExpired=function(e,t){if(void 0===e&&(e=this.tokenGetter()),null===e||""===e)return!0;var r=this.getTokenExpirationDate(e);return t=t||0,null===r||!(r.valueOf()>(new Date).valueOf()+1e3*t)},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:o.Inject,args:[Q]}]}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(Q))},token:e,providedIn:"root"}),e}(),Z=function(){function e(e,t){this.jwtHelper=t,this.tokenGetter=e.tokenGetter,this.headerName=e.headerName||"Authorization",this.authScheme=e.authScheme||""===e.authScheme?e.authScheme:"Bearer ",this.whitelistedDomains=e.whitelistedDomains||[],this.blacklistedRoutes=e.blacklistedRoutes||[],this.throwNoTokenError=e.throwNoTokenError||!1,this.skipWhenExpired=e.skipWhenExpired||!1}return e.prototype.isWhitelistedDomain=function(e){var t=new n(e.url);return null===t.host||-1<this.whitelistedDomains.findIndex(function(e){return"string"==typeof e?e===t.host:e instanceof RegExp&&e.test(t.host)})},e.prototype.isBlacklistedRoute=function(e){var t=e.url;return-1<this.blacklistedRoutes.findIndex(function(e){return"string"==typeof e?e===t:e instanceof RegExp&&e.test(t)})},e.prototype.handleInterception=function(e,t,r){var n,o=!1;if(!e&&this.throwNoTokenError)throw new Error("Could not get token from tokenGetter function.");return this.skipWhenExpired&&(o=!e||this.jwtHelper.isTokenExpired(e)),e&&o&&this.skipWhenExpired?t=t.clone():e&&this.isWhitelistedDomain(t)&&!this.isBlacklistedRoute(t)&&(t=t.clone({setHeaders:(n={},n[this.headerName]=""+this.authScheme+e,n)})),r.handle(t)},e.prototype.intercept=function(e,t){var r=this.tokenGetter?this.tokenGetter():null;return this.handleInterception(r,e,t)},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:o.Inject,args:[Q]}]},{type:X}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(Q),o.inject(X))},token:e,providedIn:"root"}),e}(),ee=function(){function e(e,t){this._http=e,this._config=t}return e.prototype.login=function(e){var t=this._config.loginUrl;return this._http.post(t,e)},e.prototype.logout=function(){var e=this._config.logoutUrl;return this._http.post(e,{})},e.prototype.refreshToken=function(e){var t=this._config.refreshTokenUrl;return this._http.post(t,{refresh_token:e})},e.prototype.getCurrentUser=function(){var e=this._config.meUrl;return this._http.get(e)},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:t.HttpClient},{type:void 0,decorators:[{type:o.Inject,args:[Y]}]}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(t.HttpClient),o.inject(Y))},token:e,providedIn:"root"}),e}(),te=function(){function e(e){this.store=e}return e.prototype.canActivate=function(){return this._guard()},e.prototype.canActivateChild=function(e,t){return this._guard()},e.prototype._guard=function(){var t=this;return this.store.pipe(r.select(N),u.filter(function(e){return e}),u.switchMap(function(){return t.store.pipe(r.select(B))}),u.map(function(e){return!!e||(t.store.dispatch(new S),!1)}),u.take(1))},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.Store}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(r.Store))},token:e,providedIn:"root"}),e}(),re=function(){},ne=function(){function e(e,t,r){var n=this;this._cdr=r,this._loginEvt=new o.EventEmitter,this._loginSub=a.Subscription.EMPTY,this.loginForm=e.group({username:[null,[i.Validators.required]],password:[null,[i.Validators.required]]}),this.valid=this.loginForm.valueChanges.pipe(u.map(function(){return n.loginForm.valid})),this._loginSub=this._loginEvt.subscribe(function(){t.dispatch(new G({credentials:n.loginForm.value}))})}return Object.defineProperty(e.prototype,"disabled",{get:function(){return this._disabled},set:function(e){this._disabled=c.forceBooleanProp(e),this._cdr.markForCheck()},enumerable:!0,configurable:!0}),e.prototype.login=function(){this._loginEvt.next()},e.prototype.ngOnDestroy=function(){this._loginSub.unsubscribe(),this._loginEvt.complete()},e}(),oe=function(){function e(e,t,r,n,o,i,c){var s=this;this.actions$=e,this.authService=t,this.jwtHelperService=r,this.userInteractionsService=n,this.router=o,this.ts=i,this.config=c,this.initUser$=this.actions$.pipe(p.ofType(b),u.exhaustMap(function(){return s.authService.getCurrentUser().pipe(u.catchError(function(e){return a.of(null)}))}),u.map(function(e){return new O({user:e})})),this.initUserComplete$=this.actions$.pipe(p.ofType(T),u.map(function(){return new P})),this.login$=this.actions$.pipe(p.ofType(U),u.map(function(e){return e.payload.credentials}),u.exhaustMap(function(e){return s.authService.login(e).pipe(u.map(function(e){return new k(e)}),u.catchError(function(e){var t=[];return 0!==e.status&&e.error.message?t.push(e.error.message):t.push("Connection problem. Please try again"),a.zip.apply(void 0,t.map(function(e){return s.ts.get(e)})).pipe(u.map(function(e){return new w({error:e})}))}))})),this.loginSuccess$=this.actions$.pipe(p.ofType(g),u.tap(function(e){var t=e.payload,r=s.config.tokenKey||"access_token",n=s.config.refreshTokenKey||"refresh_token";s.jwtHelperService.tokenSetter(t[r]),s.jwtHelperService.refreshTokenSetter(t[n]),s.router.navigate(["/"])}),u.map(function(){return s._getRefreshTokenAction()})),this.loginFailure$=this.actions$.pipe(p.ofType(y),u.tap(function(e){s.userInteractionsService.showLoginError(e.payload.error.join("\n"))})),this.refreshToken$=this.actions$.pipe(p.ofType(m),u.delayWhen(function(e){return a.timer(e.payload.refreshDelay)}),u.exhaustMap(function(n){return s.authService.refreshToken(s.jwtHelperService.refreshTokenGetter()||"").pipe(u.switchMap(function(e){var t=[],r=s.config.tokenKey||"access_token";return s.jwtHelperService.tokenSetter(e[r]),n.payload.fromInit&&t.push(new A),t.push(s._getRefreshTokenAction()),t}),u.catchError(function(){return a.of(new P)}))})),this.loginRedirect$=this.actions$.pipe(p.ofType(v,E),u.tap(function(e){s.router.navigate(["/login"])})),this.logoutConfirmation$=this.actions$.pipe(p.ofType(x),u.exhaustMap(function(){return s.userInteractionsService.askLogoutConfirm()}),u.map(function(e){return e?new $:new D})),this.init$=a.defer(function(){return a.of(null)}).pipe(u.switchMap(function(){var t=[],e=s.jwtHelperService.tokenGetter();if(e)try{if(s.jwtHelperService.isTokenExpired(e))t.push(new j({refreshDelay:0,fromInit:!0}));else{var r=s.jwtHelperService.decodeToken(e),n=s.config.disableScopes?[]:s._getScopesFromToken(r);(s.config.disableScopes||-1<n.indexOf("admin"))&&(t.push(new A),t.push(s._getRefreshTokenAction()))}}catch(e){t.push(new P)}else t.push(new P);return t}))}return e.prototype._getRefreshTokenAction=function(e){var t=this.jwtHelperService.tokenGetter(),r=this.jwtHelperService.getTokenExpirationDate(t)||new Date,n=Math.max(0,Math.round(.8*(r.getTime()-(new Date).getTime())));return new j({refreshDelay:n,fromInit:e})},e.prototype._getScopesFromToken=function(t){return(this.config.scopesPath||["scopes"]).forEach(function(e){return t=t[e]}),t},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:p.Actions},{type:ee},{type:X},{type:re},{type:s.Router},{type:f.TranslateService},{type:void 0,decorators:[{type:o.Inject,args:[Y]}]}]},l([p.Effect(),d("design:type",Object)],e.prototype,"initUser$",void 0),l([p.Effect(),d("design:type",Object)],e.prototype,"initUserComplete$",void 0),l([p.Effect(),d("design:type",Object)],e.prototype,"login$",void 0),l([p.Effect(),d("design:type",Object)],e.prototype,"loginSuccess$",void 0),l([p.Effect({dispatch:!1}),d("design:type",Object)],e.prototype,"loginFailure$",void 0),l([p.Effect(),d("design:type",Object)],e.prototype,"refreshToken$",void 0),l([p.Effect({dispatch:!1}),d("design:type",Object)],e.prototype,"loginRedirect$",void 0),l([p.Effect(),d("design:type",Object)],e.prototype,"logoutConfirmation$",void 0),l([p.Effect(),d("design:type",Object)],e.prototype,"init$",void 0),e}(),ie=function(){function e(){}return e.decorators=[{type:o.NgModule,args:[{imports:[r.StoreModule.forFeature("auth",M),p.EffectsModule.forFeature([oe])],providers:[oe,te,ee,X,Z]}]}],e}();e.reducers=V,e.AUTH_OPTIONS=Y,e.JwtInterceptor=Z,e.JWT_OPTIONS=Q,e.AuthService=ee,e.AuthGuard=te,e.JwtHelperService=X,e.AuthUserInteractionsService=re,e.LoginComponent=ne,e.AuthModule=ie,e.ɵe=oe,e.ɵc=R,e.ɵd=L,e.ɵb=M,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=core-auth.umd.min.js.map
