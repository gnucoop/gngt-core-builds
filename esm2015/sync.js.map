{"version":3,"file":"sync.js","sources":["../../../src/core/sync/sync-module.ts","../../../src/core/sync/offline-interceptor.ts","../../../src/core/sync/sync-service.ts","../../../src/core/sync/sync-options.ts"],"sourcesContent":["/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {HTTP_INTERCEPTORS} from '@angular/common/http';\nimport {ModuleWithProviders, NgModule} from '@angular/core';\n\nimport {OfflineInterceptor} from './offline-interceptor';\nimport {SYNC_OPTIONS, SyncOptions} from './sync-options';\nimport {SyncService} from './sync-service';\n\n@NgModule({})\nexport class SyncModule {\n  static forRoot(opts: SyncOptions): ModuleWithProviders {\n    return {\n      ngModule: SyncModule,\n      providers: [\n        SyncService,\n        {provide: HTTP_INTERCEPTORS, useClass: OfflineInterceptor, multi: true},\n        {provide: SYNC_OPTIONS, useValue: opts},\n      ]\n    };\n  }\n}\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {\n  HttpEvent, HttpErrorResponse, HttpHandler, HttpInterceptor, HttpRequest, HttpResponse\n} from '@angular/common/http';\nimport {Injectable} from '@angular/core';\n\nimport {Observable, throwError} from 'rxjs';\nimport {catchError, map} from 'rxjs/operators';\n\nimport {RegisteredModel} from './registered-model';\nimport {SyncService} from './sync-service';\n\n@Injectable()\nexport class OfflineInterceptor implements HttpInterceptor {\n  private _models: RegisteredModel[] = [];\n\n  constructor(private _syncService: SyncService) {\n    this._models = [..._syncService.registeredModels];\n    _syncService.modelRegister.subscribe(_ =>\n      this._models = [..._syncService.registeredModels]);\n  }\n\n  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\n    return next.handle(req).pipe(\n      catchError((e: HttpErrorResponse) => {\n        if (e.status === 0) {\n          const models = this._checkOfflineRequest(req);\n          if (models.length > 0) {\n            return this._doOfflineRequest(req, models[0], e);\n          }\n        }\n        return throwError(e);\n      })\n    );\n  }\n\n  private _doOfflineRequest(\n    req: HttpRequest<any>,\n    model: RegisteredModel,\n    reqError: HttpErrorResponse\n  ): Observable<HttpEvent<any>> {\n    const method = req.method.toLowerCase();\n    const {exactMatch, relativeUrl} = this._analyzeRequestUrl(req, model);\n    if (method === 'get') {\n      if (exactMatch) {\n        const limit = <any>req.params.get('limit');\n        const start = <any>req.params.get('start');\n        const sort = <any>req.params.get('sort');\n        const fields = <any>req.params.get('fields');\n        const joins = <any>req.params.get('joins');\n        return this._syncService.list(model.tableName, {limit, start, sort, fields, joins}).pipe(\n          catchError(_ => throwError(reqError)),\n          map(res => new HttpResponse({\n            status: 200,\n            statusText: 'OK',\n            url: req.url,\n            body: res\n          })),\n        );\n      } else {\n        if (relativeUrl.length === 1) {\n          const id = parseInt(relativeUrl[0], 10);\n          if (!isNaN(id) && id > 0) {\n            return this._syncService.get(model.tableName, {id}).pipe(\n              catchError(_ => throwError(reqError)),\n              map(res => new HttpResponse({\n                status: 200,\n                statusText: 'OK',\n                url: req.url,\n                body: res\n              })),\n            );\n          }\n        }\n      }\n    }\n    return throwError(reqError);\n  }\n\n  private _analyzeRequestUrl(\n    req: HttpRequest<any>,\n    model: RegisteredModel\n  ): {exactMatch: boolean, relativeUrl: string[]} {\n    const exactMatch = new RegExp('^' + model.endpoint + '$').test(req.url);\n    if (exactMatch) { return {exactMatch, relativeUrl: []}; }\n    const baseUrlParts = model.endpoint.split(/\\/+/);\n    const reqUrlParts = req.url.split(/\\/+/);\n    return {exactMatch, relativeUrl: reqUrlParts.slice(baseUrlParts.length)};\n  }\n\n  private _checkOfflineRequest(req: HttpRequest<any>): RegisteredModel[] {\n    return this._models.filter(m => new RegExp(`^${m.endpoint}`).test(req.url));\n  }\n}\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {HttpClient, HttpErrorResponse} from '@angular/common/http';\nimport {EventEmitter, Inject, Injectable} from '@angular/core';\n\nimport {\n  BehaviorSubject, from, Observable, of as obsOf, Subscription, throwError, timer, zip\n} from 'rxjs';\nimport {\n  catchError, concatMap, delayWhen, exhaustMap, filter, map, mapTo, switchMap, take, tap\n} from 'rxjs/operators';\n\nimport * as PouchDB from 'pouchdb';\nimport * as PouchDBDebug from 'pouchdb-debug';\nimport * as PouchDBFind from 'pouchdb-find';\n\nimport {ModelGetParams, ModelListParams, ModelSort} from '@gngt/core/common';\nimport {LocalDoc} from './local-doc';\nimport {LocalSyncEntry} from './local-sync-entry';\nimport {LocalSyncNumber} from './local-sync-number';\nimport {RegisteredModel} from './registered-model';\nimport {SyncCheckpoint} from './sync-checkpoint';\nimport {SyncEntry} from './sync-entry';\nimport {SYNC_OPTIONS, SyncOptions} from './sync-options';\nimport {SyncStatus} from './sync-status';\nimport {UpwardChange} from './upward-change';\nimport {UpwardChangeResult} from './upward-change-result';\n\ntype DatabaseContent = LocalDoc<any> | LocalSyncEntry | LocalSyncNumber | SyncCheckpoint;\n\n@Injectable()\nexport class SyncService {\n  private _status: BehaviorSubject<SyncStatus>\n    = new BehaviorSubject<SyncStatus>({status: 'initializing'});\n  readonly status: Observable<SyncStatus> = this._status.asObservable();\n  readonly registeredModels: RegisteredModel[] = [];\n\n  private _modelRegister: EventEmitter<RegisteredModel> = new EventEmitter<RegisteredModel>();\n  readonly modelRegister: Observable<RegisteredModel>;\n\n  private _timerSub: Subscription = Subscription.EMPTY;\n  private _syncing = false;\n  private _database: PouchDB.Database<DatabaseContent>;\n  private readonly _remoteCheckpointKey = 'gngt_remote_sync_checkpoint';\n  private readonly _localCheckpointKey = 'gngt_local_sync_checkpoint';\n  private readonly _localSyncNumber = 'gngt_local_sync_number';\n  private readonly _localSyncEntryPrefix = 'gngt_local_sync_entry_';\n  private readonly _syncUrl: string;\n  private readonly _changesUrl: string;\n  private readonly _relationalModelIdx: PouchDB.Find.CreateIndexOptions = {\n    index: {name: 'relational_model_idx', fields: ['table_name', 'object_id']}\n  };\n  private readonly _databaseInit: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\n  private readonly _databaseIsInit: Observable<boolean>;\n\n  constructor(@Inject(SYNC_OPTIONS) private _opts: SyncOptions, private _httpClient: HttpClient) {\n    this.modelRegister = this._modelRegister.asObservable();\n\n    if (this._opts.syncInterval == null) { this._opts.syncInterval = 300000; }\n    if (this._opts.changesBatchSize == null) { this._opts.changesBatchSize = 50; }\n\n    this._syncUrl = `${this._opts.baseUrl}/${this._opts.changesPath || 'changes'}`;\n    this._changesUrl = `${this._opts.baseUrl}/${this._opts.docsPath || 'docs'}`;\n    this._initLocalDatabase();\n    this._databaseIsInit = this._databaseInit.pipe(filter(i => i));\n  }\n\n  registerModel(endpoint: string, tableName: string): void {\n    if (this.registeredModels.find(r => r.tableName === tableName) == null) {\n      const registeredModel = {tableName, endpoint};\n      this.registeredModels.push(registeredModel);\n      this._modelRegister.emit(registeredModel);\n    }\n  }\n\n  start(immediate = true): void {\n    if (this._syncing) { return; }\n    this._syncing = true;\n    this._timerSub = timer(immediate ? 0 : this._opts.syncInterval, this._opts.syncInterval).pipe(\n      delayWhen(_ => this._databaseIsInit),\n    ).subscribe(_ => this._checkSync());\n  }\n\n  stop(): void {\n    if (!this._syncing) { return; }\n    this._timerSub.unsubscribe();\n    this._syncing = false;\n  }\n\n  get(tableName: string, params: ModelGetParams): Observable<any> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => this._relationalModelIdxObs()),\n      exhaustMap(_ => from(db.find(\n        this._modelGetFindRequest(tableName, params))).pipe(take(1))),\n      switchMap(res => {\n        if (res.docs.length === 1) {\n          let obj = this._subObject(res.docs[0].object, params.fields);\n          if (params.joins != null) {\n            return zip(...params.joins.map(join =>\n              from(db.find(\n                this._modelGetFindRequest(join.model, {id: obj[join.property], fields: join.fields})\n              )).pipe(\n                take(1),\n                map(related => related.docs.length === 1 ? related.docs[0].object : null),\n                map(related => ({join, related})),\n              )\n            )).pipe(\n              map(joins => {\n                joins.forEach(joinEntry => {\n                  obj[joinEntry.join.property] = joinEntry.related;\n                });\n                return obj;\n              })\n            );\n          }\n          return obsOf(obj);\n        }\n        return throwError('not_found');\n      }),\n    );\n  }\n\n  list(tableName: string, params: ModelListParams): Observable<any[]> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => this._relationalModelIdxObs({tableName, sort: params.sort})),\n      exhaustMap(idx => from(db.find(\n        this._modelListFindRequest(tableName, params, idx)\n      )).pipe(take(1))),\n      switchMap(res => {\n        if (params.joins != null) {\n          const joinTables: {[table: string]: number[]} = params.joins.reduce((prev, cur) => {\n            prev[cur.model] = res.docs.map(d => d.object[cur.property]);\n            return prev;\n          }, {} as {[table: string]: number[]});\n          return zip(...params.joins.map(join => {\n              const req = this._modelListFindRequest(join.model, {fields: join.fields});\n              req.selector['object_id'] = {'$in': joinTables[join.model]};\n              return from(db.find(req)).pipe(\n                take(1),\n                map(related => ({join, related: related.docs})),\n              );\n          })).pipe(\n            map(joins => {\n              return res.docs.map(doc => {\n                const obj = doc.object;\n                joins.forEach(joinEntry => {\n                  const prop = joinEntry.join.property;\n                  const rel = joinEntry.related.find(r => r.object_id === obj[prop]);\n                  obj[prop] = rel != null ? rel.object : null;\n                });\n                return this._subObject(obj, params.fields);\n              });\n            }),\n          );\n        }\n        return obsOf(res.docs.map(d => this._subObject(d.object, params.fields)));\n      }),\n    );\n  }\n\n  create(tableName: string, object: any): Observable<number> {\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => this._nextObjectId(tableName)),\n      exhaustMap(id => {\n        object = {id, ...object};\n        const localDoc = {table_name: tableName, object_id: id};\n        return from(this._database.post({...localDoc, object})).pipe(\n          exhaustMap(doc => this._createLocalSyncEntry(\n            {doc_id: doc.id, entry_type: 'insert', ...localDoc}\n          )),\n          map(_ => id),\n        );\n      }),\n      take(1),\n    );\n  }\n\n  update(tableName: string, id: number, object: any): Observable<number> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => from(db.find(this._modelGetFindRequest(tableName, {id}))).pipe(take(1))),\n      exhaustMap(res => {\n        if (res.docs.length !== 1) {\n          return throwError('not_found');\n        }\n        const localDoc = {...res.docs[0], object};\n        return from(db.post(localDoc)).pipe(take(1));\n      }),\n      exhaustMap(res => {\n        const syncEntry: Partial<LocalSyncEntry> = {\n          doc_id: res.id,\n          table_name: tableName,\n          object_id: id,\n          entry_type: 'update'\n        };\n        return this._createLocalSyncEntry(syncEntry);\n      }),\n      take(1),\n      map(_ => id),\n    );\n  }\n\n  delete(tableName: string, id: number): Observable<number> {\n    const db = this._getLocalDocsDb();\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => from(db.find(this._modelGetFindRequest(tableName, {id}))).pipe(take(1))),\n      exhaustMap(res => {\n        if (res.docs.length !== 1) {\n          return throwError('not_found');\n        }\n        const localDoc = res.docs[0];\n        return from(db.remove(localDoc)).pipe(take(1));\n      }),\n      exhaustMap(res => {\n        const syncEntry: Partial<LocalSyncEntry> = {\n          doc_id: res.id,\n          table_name: tableName,\n          object_id: id,\n          entry_type: 'delete'\n        };\n        return this._createLocalSyncEntry(syncEntry);\n      }),\n      take(1),\n      map(_ => id),\n    );\n  }\n\n  private _getLocalDocsDb(): PouchDB.Database<LocalDoc<any>> {\n    return this._database as PouchDB.Database<LocalDoc<any>>;\n  }\n\n  private _getLocalSyncDb(): PouchDB.Database<LocalSyncEntry> {\n    return this._database as PouchDB.Database<LocalSyncEntry>;\n  }\n\n  private _getLocalSyncNumberDb(): PouchDB.Database<LocalSyncNumber> {\n    return this._database as PouchDB.Database<LocalSyncNumber>;\n  }\n\n  private _getSyncCheckpointDb(): PouchDB.Database<SyncCheckpoint> {\n    return this._database as PouchDB.Database<SyncCheckpoint>;\n  }\n\n  private _createLocalSyncEntry(syncEntry: Partial<LocalSyncEntry>): Observable<number> {\n    return this._getNextLocalSyncNumber().pipe(\n      exhaustMap(syncNumber => {\n        syncEntry._id = `_local/${this._localSyncEntryPrefix}${syncNumber}`;\n        syncEntry.sequence = syncNumber;\n        return from(this._database.put<LocalSyncEntry>(syncEntry as LocalSyncEntry)).pipe(\n          take(1),\n          exhaustMap(_ => this._setLocalSyncNumber(syncNumber)),\n          take(1),\n        );\n      }),\n    );\n  }\n\n  private _setLocalSyncNumber(syncNumber: number): Observable<number> {\n    const db = this._getLocalSyncNumberDb();\n    const id = `_local/${this._localSyncNumber}`;\n    return from(db.get(id)).pipe(\n      take(1),\n      catchError(_ => obsOf({_id: id, number: 0} as LocalSyncNumber)),\n      exhaustMap(doc => from(db.post({...doc, number: syncNumber})).pipe(take(1))),\n      map(_ => syncNumber),\n    );\n  }\n\n  private _getNextLocalSyncNumber(): Observable<number> {\n    const db = this._getLocalSyncNumberDb();\n    return from(db.get(`_local/${this._localSyncNumber}`)\n    ).pipe(\n      take(1),\n      map(doc => doc.number + 1),\n      catchError(_ => obsOf(1)),\n    );\n  }\n\n  private _nextObjectId(tableName: string): Observable<number> {\n    const sort = {object_id: 'desc'} as ModelSort;\n    const db = this._getLocalDocsDb();\n    return this._relationalModelIdxObs({tableName, sort}).pipe(\n      exhaustMap(idx => from(db.find(\n        this._modelListFindRequest(tableName, {sort}, idx)\n      )).pipe(take(1))),\n      map(res => res.docs.length > 0 ? res.docs[0].object_id + 1 : 1),\n    );\n  }\n\n  private _relationalModelIdxObs(\n    idxDef?: {tableName: string, sort?: ModelSort}\n  ): Observable<PouchDB.Find.CreateIndexResponse<LocalDoc<any>>> {\n    if (idxDef != null && idxDef.sort != null) {\n      let {dir, fields} = this._normalizeSortParam(idxDef.sort);\n      fields = [{table_name: dir}, ...fields];\n      if (fields.length > 0) {\n        return from(this._database.createIndex({\n          index: {\n            name: this._generateIndexName(idxDef.tableName, fields),\n            fields: fields as any\n          }\n        }));\n      }\n    }\n    return from(this._database.createIndex(this._relationalModelIdx)).pipe(take(1));\n  }\n\n  private _generateIndexName(tableName: string, fields: ModelSort[]): string {\n    return `idx___${tableName}___${fields.map(f => {\n      const key = Object.keys(f)[0];\n      return `${key}__${f[key]}`;\n    }).join('___')}`;\n  }\n\n  private _subObject(obj: any, fields?: string[]): any {\n    if (obj == null || fields == null) { return obj; }\n    obj = obj || {};\n    const subObj: any = {};\n    (fields || []).forEach(f => subObj[f] = obj[f]);\n    return subObj;\n  }\n\n  private _checkSync(): void {\n    this._checkUpwardSync();\n  }\n\n  private _checkUpwardSync(): void {\n    zip(this._getLastLocalCheckpoint(), this._getNextLocalSyncNumber()).pipe(\n      exhaustMap(([checkpoint, syncNumber]) => {\n        const localSyncDb = this._getLocalSyncDb();\n        const gets: Observable<LocalSyncEntry>[] = [];\n        const firstId = checkpoint + 1;\n        const lastId = Math.min(firstId + this._opts.changesBatchSize! - 1, syncNumber - 1);\n        if (lastId <= checkpoint) {\n          return obsOf(false);\n        }\n\n        const hasNext = lastId < syncNumber - 1;\n\n        this.stop();\n\n        for (let i = firstId ; i <= lastId ; i++) {\n          gets.push(from(localSyncDb.get(`_local/${this._localSyncEntryPrefix}${i}`)));\n        }\n        return zip(...gets).pipe(\n          exhaustMap(entries => {\n            const localDocsDb = this._getLocalDocsDb();\n            const opts = {keys: entries.map(e => e.doc_id), include_docs: true};\n            return from(localDocsDb.allDocs(opts)).pipe(\n              map(localDocs => {\n                const docs = entries.map(\n                  (syncEntry, i) => ({syncEntry, localDoc: localDocs.rows[i].doc!})\n                );\n                return {hasNext, docs};\n              }),\n              take(1),\n            );\n          }),\n          exhaustMap(res => this._processUpwardChanges(res)),\n          take(1),\n        );\n      }),\n    ).subscribe(\n      hasNext => {\n        if (hasNext) {\n          this._checkUpwardSync();\n        } else {\n          this._checkDownwardSync();\n        }\n      },\n      err => {\n        this._emitSyncError(err);\n        this.start(false);\n      }\n    );\n  }\n\n  private _checkDownwardSync(): void {\n    this._getLastRemoteCheckpoint().pipe(\n      exhaustMap(since => {\n        const params = `since=${since}&batchSize=${this._opts.changesBatchSize}`;\n        return this._httpClient.get<SyncEntry[]>(`${this._syncUrl}?${params}`);\n      })\n    ).subscribe(changes => {\n      this.stop();\n      this._processDownwardChanges(changes);\n    });\n  }\n\n  private _getLastLocalCheckpoint(): Observable<number> {\n    return this._getLastCheckpoint(this._localCheckpointKey);\n  }\n\n  private _getLastRemoteCheckpoint(): Observable<number> {\n    return this._getLastCheckpoint(this._remoteCheckpointKey);\n  }\n\n  private _getLastCheckpoint(checkpointKey: string): Observable<number> {\n    const db = this._getSyncCheckpointDb();\n    return from(db.get(`_local/${checkpointKey}`)).pipe(\n      map(d => d.checkpoint),\n      catchError(_ => obsOf(0)),\n    );\n  }\n\n  private _setLastLocalCheckpoint(checkpoint: number): Observable<number> {\n    return this._setLastCheckpoint(this._localCheckpointKey, checkpoint);\n  }\n\n  private _setLastRemoteCheckpoint(checkpoint: number): Observable<number> {\n    return this._setLastCheckpoint(this._remoteCheckpointKey, checkpoint);\n  }\n\n  private _setLastCheckpoint(checkpointKey: string, checkpoint: number): Observable<number> {\n    const db = this._getSyncCheckpointDb();\n    const docKey = `_local/${checkpointKey}`;\n    const doc = {_id: docKey, checkpoint} as SyncCheckpoint;\n    return from(db.get(docKey)).pipe(\n      catchError(_ => obsOf({} as SyncCheckpoint)),\n      take(1),\n      exhaustMap(d => from(db.put({...d, ...doc})).pipe(take(1))),\n      catchError(_ => throwError('checkpoint_set_failed')),\n      mapTo(checkpoint),\n    );\n  }\n\n  private _processUpwardChanges(p: {hasNext: boolean, docs: UpwardChange[]}): Observable<boolean> {\n    const payload = p.docs.map(doc => {\n      return {\n        sequence: doc.syncEntry.sequence,\n        table_name: doc.syncEntry.table_name,\n        object_id: doc.syncEntry.object_id,\n        entry_type: doc.syncEntry.entry_type,\n        object: doc.localDoc.object\n      };\n    });\n    return this._httpClient.post<UpwardChangeResult[]>(this._syncUrl, payload).pipe(\n      map(res => res[res.length - 1].sequence),\n      catchError((err: HttpErrorResponse) => {\n        if (err.status !== 417) {\n          return throwError(err);\n        }\n        p.hasNext = true;\n        return this._resolveUpwardConflict(p.docs, err.error);\n      }),\n      exhaustMap(sequence => sequence >= 0 ? this._setLastLocalCheckpoint(sequence) : obsOf(null)),\n      map(_ => p.hasNext),\n    );\n  }\n\n  private _resolveUpwardConflict(\n    docs: UpwardChange[], result: UpwardChangeResult[]\n  ): Observable<number> {\n    const conflictIdx = result.findIndex(r => r.ok === false && r.error === 'conflict')!;\n    const conflict = result[conflictIdx];\n    const conflictDoc = docs.find(d => d.syncEntry.sequence === conflict.sequence)!;\n    const checkpoint = conflictIdx > 0 ? result[conflictIdx - 1].sequence : -1;\n    const localDocsDb = this._getLocalDocsDb();\n    const findReq = this._modelListFindRequest(conflictDoc.syncEntry.table_name, {});\n    findReq.selector['object_id'] = {$gte: conflictDoc.syncEntry.object_id};\n    return this._databaseIsInit.pipe(\n      exhaustMap(_ => from(localDocsDb.find(findReq)).pipe(take(1))),\n      exhaustMap(res => {\n        const updDocs = res.docs.map((doc, idx) => {\n          doc.object_id = doc.object.id = conflict.extra.next_id + idx;\n          return doc;\n        });\n        return from(localDocsDb.bulkDocs(updDocs)).pipe(take(1));\n      }),\n      map(_ => checkpoint),\n    );\n  }\n\n  private _processDownwardChanges(syncEntries: SyncEntry[]): void {\n    if (syncEntries == null || syncEntries.length === 0) {\n      this._emitSyncPaused();\n      this.start(false);\n      return;\n    }\n    const changes = syncEntries.map(s => s.id);\n    const url = this._changesUrl;\n    this._httpClient.post<SyncEntry[]>(url, {changes}).pipe(\n      catchError(_ => {\n        this._emitSyncError('network_error');\n        return obsOf([] as SyncEntry[]);\n      }),\n      switchMap(docs => from(\n        changes.map(change => ({change, doc: (docs || []).find(d => d.id === change)}))\n      )),\n      tap(_ => this._emitSyncSyncing()),\n      concatMap(({change, doc}) => doc == null\n        ? throwError(`missing_change_${change}`)\n        : this._processDownwardChange(doc)\n      ),\n      concatMap(change => this._setLastRemoteCheckpoint(change.id))\n    ).subscribe(\n      _ => {},\n      error => {\n        this._emitSyncError(error);\n        this.start(false);\n      },\n      () => {\n        const hasMore = changes.length > 0;\n        if (!hasMore) {\n          this._emitSyncPaused();\n        }\n        this.start(hasMore);\n      }\n    );\n  }\n\n  private _emitSyncError(error: string): void {\n    this._status.next({status: 'error', error});\n  }\n\n  private _emitSyncPaused(): void {\n    this._status.next({status: 'paused'});\n  }\n\n  private _emitSyncSyncing(): void {\n    this._status.next({status: 'syncing'});\n  }\n\n  private _processDownwardChange(change: SyncEntry): Observable<SyncEntry> {\n    if (\n      change.entry_type !== 'insert'\n      && change.entry_type !== 'update'\n      && change.entry_type !== 'delete'\n    ) {\n      return throwError('invalid_entry_type');\n    }\n\n    const baseReq = this._relationalModelIdxObs().pipe(\n      exhaustMap(_ => from(this._database.find(this._syncEntryFindRequest(change))).pipe(take(1))),\n    );\n\n    if (change.entry_type === 'insert') {\n      return baseReq.pipe(\n        exhaustMap(localDocs => {\n          if (localDocs.docs.length !== 0) {\n            return throwError('existing_doc');\n          }\n          return from(this._database.post(this._syncEntryToLocalDoc(change))).pipe(take(1));\n        }),\n        mapTo(change),\n      );\n    }\n\n    return baseReq.pipe(\n      exhaustMap(localDocs => {\n        if (localDocs.docs.length !== 1) {\n          return throwError('unexisting_doc');\n        }\n\n        const localDoc = localDocs.docs[0];\n        const op = from(change.entry_type === 'update'\n          ? this._database.put({...localDoc, object: change.object})\n          : this._database.remove(localDoc));\n        return op.pipe(\n          take(1),\n          mapTo(change),\n        );\n      })\n    );\n  }\n\n  private _modelGetFindRequest(\n    tableName: string, params: ModelGetParams\n  ): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    return {\n      selector: {table_name: tableName, object_id: params.id}\n    };\n  }\n\n  private _modelListFindRequest(\n    tableName: string, params: ModelListParams,\n    index?: PouchDB.Find.CreateIndexResponse<LocalDoc<any>>\n  ): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    const req: PouchDB.Find.FindRequest<LocalDoc<any>> = {\n      selector: {table_name: tableName}\n    };\n    if (params.sort != null) {\n      const {dir, fields} = this._normalizeSortParam(params.sort);\n      req.sort = [{table_name: dir}, ...fields];\n    } else {\n      req.sort = ['table_name', 'object_id'];\n    }\n    if (params.start != null) {\n      req.skip = params.start;\n    }\n    if (params.limit != null) {\n      req.limit = params.limit;\n    }\n    if (index != null) {\n      const idxParts = ((index as any).id || '').split('/');\n      if (idxParts.length === 2) {\n        req.use_index = idxParts[1];\n      }\n    }\n    return req;\n  }\n\n  private _normalizeSortParam(\n    sortParam: {[prop: string]: 'asc' | 'desc'}\n  ): {dir: 'asc' | 'desc', fields: ModelSort[]} {\n    let dir: 'asc' | 'desc' = 'asc';\n    const fields = Object.keys(sortParam).map((key, i) => {\n      const sort: any = {};\n      if (i == 0) { dir = sortParam[key]; }\n      sort[key !== 'object_id' ? `object.${key}` : key] = dir;\n      return sort;\n    });\n    return {dir, fields};\n  }\n\n  private _syncEntryFindRequest(entry: SyncEntry): PouchDB.Find.FindRequest<LocalDoc<any>> {\n    return {selector : this._syncEntryFindSelector(entry)};\n  }\n\n  private _syncEntryFindSelector(entry: SyncEntry): PouchDB.Find.Selector {\n    return {\n      table_name: entry.table_name,\n      object_id: entry.object_id,\n    };\n  }\n\n  private _initLocalDatabase(): void {\n    PouchDB.plugin(PouchDBFind);\n    PouchDB.plugin(PouchDBDebug);\n    this._database = new PouchDB(this._opts.localDatabaseName, {revs_limit: 1});\n\n    this._database.createIndex(this._relationalModelIdx)\n      .then(_ => {\n        this._emitSyncPaused();\n        this._databaseInit.next(true);\n      })\n      .catch(_ => this._emitSyncError('indexing_failed'));\n  }\n\n  private _syncEntryToLocalDoc(entry: SyncEntry): LocalDoc<any> {\n    return {\n      object_id: entry.object_id,\n      table_name: entry.table_name,\n      object: entry.object\n    };\n  }\n}\n","/**\n * @license\n * Copyright (C) 2018 Gnucoop soc. coop.\n *\n * This file is part of the Gnucoop Angular Toolkit (gngt).\n *\n * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.\n *\n */\n\nimport {InjectionToken} from '@angular/core';\n\nexport interface SyncOptions {\n  baseUrl: string;\n  changesPath?: string;\n  docsPath?: string;\n  localDatabaseName: string;\n  syncInterval?: number;\n  changesBatchSize?: number;\n}\n\nexport const SYNC_OPTIONS = new InjectionToken<SyncOptions>('SYNC_OPTIONS');\n"],"names":["PouchDB.plugin","obsOf"],"mappings":"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"}