/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
import { coerceBooleanProperty } from '@angular/cdk/coercion';
import { ChangeDetectorRef, Directive, EventEmitter, Input, Output } from '@angular/core';
import { FormBuilder } from '@angular/forms';
import { Router } from '@angular/router';
import { ModelService } from '@gngt/core/model';
import { BehaviorSubject, combineLatest, Observable, of as obsOf, Subscription } from 'rxjs';
import { filter, map, mapTo, shareReplay, switchMap, take, tap, withLatestFrom } from 'rxjs/operators';
export class AdminEditComponent {
    constructor(_cdr, _fb, _router) {
        this._cdr = _cdr;
        this._fb = _fb;
        this._router = _router;
        this._title = '';
        this._cancelLabel = 'Cancel';
        this._saveLabel = 'Save';
        this._service = new BehaviorSubject(null);
        this._fields = [];
        this._id = new BehaviorSubject(null);
        this._loading = new BehaviorSubject(false);
        this.loading = this._loading;
        this._updateFormEvt = new EventEmitter();
        this._saveEvt = new EventEmitter();
        this._saveSub = Subscription.EMPTY;
        this._processFormData = this._defaultProcessData;
        const objObs = combineLatest(this._service, this._id)
            .pipe(filter(([s, i]) => s != null && i != null), map(([s, i]) => [s, i]), switchMap(([s, i]) => {
            if (i === 'new') {
                return obsOf({});
            }
            return s.get(i);
        }), filter(o => o != null), switchMap(o => {
            if (this._processObject) {
                if (this._processObject instanceof Observable) {
                    return this._processObject.pipe(tap(po => po(o)), mapTo(o));
                }
                else {
                    this._processObject(o);
                }
            }
            return obsOf(o);
        }), shareReplay(1));
        this.form = combineLatest(objObs, this._updateFormEvt)
            .pipe(map(r => {
            const model = r[0];
            return this._fb.group((this._fields || []).reduce((prev, cur) => {
                const val = model ? model[cur.name] : null;
                prev[cur.name] = [val, cur.validators];
                return prev;
            }, {}));
        }), shareReplay(1));
        this._valueChanges$ = this.form.pipe(switchMap((form) => form.valueChanges));
        const serviceObs = this._service.pipe(filter(s => s != null));
        this._saveSub =
            this._saveEvt
                .pipe(withLatestFrom(this.form, serviceObs, this._id), map(r => r.slice(1)), filter(([form, service, _id]) => form != null && service != null && form.valid), switchMap(([form, service, id]) => {
                const formValue = Object.assign({}, form.value);
                this._defaultProcessData(formValue);
                if (this._processFormData) {
                    if (this._processFormData instanceof Observable) {
                        return this._processFormData.pipe(tap(pd => pd(formValue)), mapTo([
                            formValue, service, id
                        ]));
                    }
                    else {
                        this._processFormData(formValue);
                    }
                }
                return obsOf([formValue, service, id]);
            }), tap(r => this._loading.next(true)), switchMap(r => {
                const [formValue, service, id] = r;
                if (id === 'new') {
                    delete formValue['id'];
                    return service.create(formValue);
                }
                return service.patch(formValue);
            }), map(obj => obj), take(1), switchMap(r => {
                if (this._postSaveHook == null) {
                    return obsOf(r);
                }
                return this._postSaveHook(r);
            }))
                .subscribe(() => {
                this._loading.next(false);
                this.goBack();
            }, () => this._loading.next(false));
    }
    get title() {
        return this._title;
    }
    set title(title) {
        this._title = title;
        this._cdr.markForCheck();
    }
    set listUrl(listUrl) {
        this._listUrl = listUrl;
    }
    get cancelLabel() {
        return this._cancelLabel;
    }
    set cancelLabel(cancelLabel) {
        this._cancelLabel = cancelLabel;
        this._cdr.markForCheck();
    }
    get saveLabel() {
        return this._saveLabel;
    }
    set saveLabel(saveLabel) {
        this._saveLabel = saveLabel;
        this._cdr.markForCheck();
    }
    set service(service) {
        this._service.next(service);
    }
    get fields() {
        return this._fields;
    }
    set fields(fields) {
        this._fields = fields;
        this._updateForm();
    }
    set id(id) {
        this._id.next(id);
    }
    set processObject(processObject) {
        this._processObject = processObject;
    }
    set processFormData(processFormData) {
        this._processFormData = processFormData;
    }
    get readonly() {
        return this._readonly;
    }
    set readonly(readonly) {
        readonly = coerceBooleanProperty(readonly);
        if (readonly !== this._readonly) {
            this._readonly = readonly;
            this._cdr.markForCheck();
        }
    }
    get hideSaveButton() {
        return this._hideSaveButton;
    }
    set hideSaveButton(hideSaveButton) {
        hideSaveButton = coerceBooleanProperty(hideSaveButton);
        if (hideSaveButton !== this._hideSaveButton) {
            this._hideSaveButton = hideSaveButton;
            this._cdr.markForCheck();
        }
    }
    get canSave() {
        return this._canSave;
    }
    set canSave(canSave) {
        canSave = coerceBooleanProperty(canSave);
        if (canSave !== this._canSave) {
            this._canSave = canSave;
            this._cdr.markForCheck();
        }
    }
    set postSaveHook(postSaveHook) {
        this._postSaveHook = postSaveHook;
    }
    get valueChanges$() {
        return this._valueChanges$;
    }
    goBack() {
        this._router.navigate([this._listUrl]);
    }
    save() {
        this._saveEvt.emit();
    }
    ngOnDestroy() {
        this._updateFormEvt.complete();
        this._saveEvt.complete();
        this._saveSub.unsubscribe();
    }
    _defaultProcessData(value) {
        this._fields.forEach((field) => {
            if (field.subtype) {
                switch (field.subtype) {
                    case 'number':
                        if (value[field.name] != null && typeof value[field.name] === 'string') {
                            if (value[field.name].includes('.')) {
                                value[field.name] = parseFloat(value[field.name]);
                            }
                            else {
                                value[field.name] = parseInt(value[field.name]);
                            }
                        }
                        break;
                }
            }
        });
    }
    _updateForm() {
        this._updateFormEvt.emit();
    }
}
AdminEditComponent.decorators = [
    { type: Directive }
];
AdminEditComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: FormBuilder },
    { type: Router }
];
AdminEditComponent.propDecorators = {
    title: [{ type: Input }],
    listUrl: [{ type: Input }],
    cancelLabel: [{ type: Input }],
    saveLabel: [{ type: Input }],
    service: [{ type: Input }],
    fields: [{ type: Input }],
    id: [{ type: Input }],
    processObject: [{ type: Input }],
    processFormData: [{ type: Input }],
    readonly: [{ type: Input }],
    hideSaveButton: [{ type: Input }],
    canSave: [{ type: Input }],
    postSaveHook: [{ type: Input }],
    valueChanges$: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2FkbWluL2VkaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FtQkc7QUFFSCxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUM1RCxPQUFPLEVBQUMsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQWEsTUFBTSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ25HLE9BQU8sRUFBQyxXQUFXLEVBQVksTUFBTSxnQkFBZ0IsQ0FBQztBQUN0RCxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFFdkMsT0FBTyxFQUFtQixZQUFZLEVBQXNCLE1BQU0sa0JBQWtCLENBQUM7QUFDckYsT0FBTyxFQUFDLGVBQWUsRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLEVBQUUsSUFBSSxLQUFLLEVBQUUsWUFBWSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQzNGLE9BQU8sRUFDTCxNQUFNLEVBQ04sR0FBRyxFQUNILEtBQUssRUFDTCxXQUFXLEVBQ1gsU0FBUyxFQUNULElBQUksRUFDSixHQUFHLEVBQ0gsY0FBYyxFQUNmLE1BQU0sZ0JBQWdCLENBQUM7QUFNeEIsTUFBTSxPQUFnQixrQkFBa0I7SUF3SXRDLFlBQW9CLElBQXVCLEVBQVUsR0FBZ0IsRUFBVSxPQUFlO1FBQTFFLFNBQUksR0FBSixJQUFJLENBQW1CO1FBQVUsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUFVLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFySXRGLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFnQlosaUJBQVksR0FBRyxRQUFRLENBQUM7UUFVeEIsZUFBVSxHQUFHLE1BQU0sQ0FBQztRQVVwQixhQUFRLEdBQ1osSUFBSSxlQUFlLENBQTZCLElBQUksQ0FBQyxDQUFDO1FBTWxELFlBQU8sR0FBcUIs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Z0NBQ25DLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzs2QkFDbkQ7aUNBQU07Z0NBQ0wsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDOzZCQUNqRDt5QkFDRjt3QkFDRCxNQUFNO2lCQUNUO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxXQUFXO1FBQ2pCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDN0IsQ0FBQzs7O1lBN1FGLFNBQVM7OztZQXBCRixpQkFBaUI7WUFDakIsV0FBVztZQUNYLE1BQU07OztvQkEwQlgsS0FBSztzQkFPTCxLQUFLOzBCQVNMLEtBQUs7d0JBVUwsS0FBSztzQkFRTCxLQUFLO3FCQVNMLEtBQUs7aUJBT0wsS0FBSzs0QkFNTCxLQUFLOzhCQU1MLEtBQUs7dUJBU0wsS0FBSzs2QkFhTCxLQUFLO3NCQWFMLEtBQUs7MkJBVUwsS0FBSzs0QkFpQkwsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoQykgR251Y29vcCBzb2MuIGNvb3AuXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIEdudWNvb3AgQW5ndWxhciBUb29sa2l0IChnbmd0KS5cbiAqXG4gKiBHbnVjb29wIEFuZ3VsYXIgVG9vbGtpdCAoZ25ndCkgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEdudWNvb3AgQW5ndWxhciBUb29sa2l0IChnbmd0KSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggR251Y29vcCBBbmd1bGFyIFRvb2xraXQgKGduZ3QpLiAgSWYgbm90LCBzZWUgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLy5cbiAqXG4gKi9cblxuaW1wb3J0IHtjb2VyY2VCb29sZWFuUHJvcGVydHl9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQge0NoYW5nZURldGVjdG9yUmVmLCBEaXJlY3RpdmUsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uRGVzdHJveSwgT3V0cHV0fSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7Rm9ybUJ1aWxkZXIsIEZvcm1Hcm91cH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtSb3V0ZXJ9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQge01vZGVsfSBmcm9tICdAZ25ndC9jb3JlL2NvbW1vbic7XG5pbXBvcnQge01vZGVsQWN0aW9uVHlwZXMsIE1vZGVsU2VydmljZSwgU3RhdGUgYXMgTW9kZWxTdGF0ZX0gZnJvbSAnQGduZ3QvY29yZS9tb2RlbCc7XG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgYXMgb2JzT2YsIFN1YnNjcmlwdGlvbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBmaWx0ZXIsXG4gIG1hcCxcbiAgbWFwVG8sXG4gIHNoYXJlUmVwbGF5LFxuICBzd2l0Y2hNYXAsXG4gIHRha2UsXG4gIHRhcCxcbiAgd2l0aExhdGVzdEZyb21cbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge0FkbWluRWRpdEZpZWxkfSBmcm9tICcuL2VkaXQtZmllbGQnO1xuaW1wb3J0IHtQcm9jZXNzRGF0YUZufSBmcm9tICcuL3Byb2Nlc3MtZGF0YS1mbic7XG5cbkBEaXJlY3RpdmUoKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFkbWluRWRpdENvbXBvbmVudDxcbiAgICBUIGV4dGVuZHMgTW9kZWwgPSBNb2RlbCwgUyBleHRlbmRzIE1vZGVsU3RhdGU8VD4gPSBNb2RlbFN0YXRlPFQ+LCBBIGV4dGVuZHNcbiAgICAgICAgTW9kZWxBY3Rpb25UeXBlcyA9IE1vZGVsQWN0aW9uVHlwZXM+IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBfdGl0bGUgPSAnJztcbiAgZ2V0IHRpdGxlKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX3RpdGxlO1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCB0aXRsZSh0aXRsZTogc3RyaW5nKSB7XG4gICAgdGhpcy5fdGl0bGUgPSB0aXRsZTtcbiAgICB0aGlzLl9jZHIubWFya0ZvckNoZWNrKCk7XG4gIH1cblxuICBwcml2YXRlIF9saXN0VXJsOiBzdHJpbmc7XG4gIEBJbnB1dCgpXG4gIHNldCBsaXN0VXJsKGxpc3RVcmw6IHN0cmluZykge1xuICAgIHRoaXMuX2xpc3RVcmwgPSBsaXN0VXJsO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2FuY2VsTGFiZWwgPSAnQ2FuY2VsJztcbiAgZ2V0IGNhbmNlbExhYmVsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2NhbmNlbExhYmVsO1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCBjYW5jZWxMYWJlbChjYW5jZWxMYWJlbDogc3RyaW5nKSB7XG4gICAgdGhpcy5fY2FuY2VsTGFiZWwgPSBjYW5jZWxMYWJlbDtcbiAgICB0aGlzLl9jZHIubWFya0ZvckNoZWNrKCk7XG4gIH1cblxuICBwcml2YXRlIF9zYXZlTGFiZWwgPSAnU2F2ZSc7XG4gIGdldCBzYXZlTGFiZWwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fc2F2ZUxhYmVsO1xuICB9XG4gIEBJbnB1dCgpXG4gIHNldCBzYXZlTGFiZWwoc2F2ZUxhYmVsOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9zYXZlTGFiZWwgPSBzYXZlTGFiZWw7XG4gICAgdGhpcy5fY2RyLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2VydmljZTogQmVoYXZpb3JTdWJqZWN0PE1vZGVsU2VydmljZTxULCBTLCBBPnxudWxsPiA9XG4gICAgICBuZXcgQmVoYXZpb3JTdWJqZWN0PE1vZGVsU2VydmljZTxULCBTLCBBPnxudWxsPihudWxsKTtcbiAgQElucHV0KClcbiAgc2V0IHNlcnZpY2Uoc2VydmljZTogTW9kZWxTZXJ2aWNlPFQsIFMsIEE+KSB7XG4gICAgdGhpcy5fc2VydmljZS5uZXh0KHNlcnZpY2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZmllbGRzOiBBZG1pbkVkaXRGaWVsZFtdID0gW107XG4gIGdldCBmaWVsZHMoKTogQWRtaW5FZGl0RmllbGRbXSB7XG4gICAgcmV0dXJuIHRoaXMuX2ZpZWxkcztcbiAgfVxuICBASW5wdXQoKVxuICBzZXQgZmllbGRzKGZpZWxkczogQWRtaW5FZGl0RmllbGRbXSkge1xuICAgIHRoaXMuX2ZpZWxkcyA9IGZpZWxkcztcbiAgICB0aGlzLl91cGRhdGVGb3JtKCk7XG4gIH1cblxuICBwcml2YXRlIF9pZDogQmVoYXZpb3JTdWJqZWN0PG51bWJlcnwnbmV3J3xudWxsPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8bnVtYmVyfCduZXcnfG51bGw+KG51bGwpO1xuICBASW5wdXQoKVxuICBzZXQgaWQoaWQ6IG51bWJlcnwnbmV3Jykge1xuICAgIHRoaXMuX2lkLm5leHQoaWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBfcHJvY2Vzc09iamVjdDogUHJvY2Vzc0RhdGFGbnxPYnNlcnZhYmxlPFByb2Nlc3NEYXRhRm4+O1xuICBASW5wdXQoKVxuICBzZXQgcHJvY2Vzc09iamVjdChwcm9jZXNzT2JqZWN0OiBQcm9jZXNzRGF0YUZufE9ic2VydmFibGU8UHJvY2Vzc0RhdGFGbj4pIHtcbiAgICB0aGlzLl9wcm9jZXNzT2JqZWN0ID0gcHJvY2Vzc09iamVjdDtcbiAgfVxuXG4gIHByaXZhdGUgX3Byb2Nlc3NGb3JtRGF0YTogUHJvY2Vzc0RhdGFGbnxPYnNlcnZhYmxlPFByb2Nlc3NEYXRhRm4+O1xuICBASW5wdXQoKVxuICBzZXQgcHJvY2Vzc0Zvcm1EYXRhKHByb2Nlc3NGb3JtRGF0YTogUHJvY2Vzc0RhdGFGbnxPYnNlcnZhYmxlPFByb2Nlc3NEYXRhRm4+KSB7XG4gICAgdGhpcy5fcHJvY2Vzc0Zvcm1EYXRhID0gcHJvY2Vzc0Zvcm1EYXRhO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVhZG9ubHk6IGJvb2xlYW47XG4gIGdldCByZWFkb25seSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fcmVhZG9ubHk7XG4gIH1cbiAgQElucHV0KClcbiAgc2V0IHJlYWRvbmx5KHJlYWRvbmx5OiBib29sZWFuKSB7XG4gICAgcmVhZG9ubHkgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkocmVhZG9ubHkpO1xuICAgIGlmIChyZWFkb25seSAhPT0gdGhpcy5fcmVhZG9ubHkpIHtcbiAgICAgIHRoaXMuX3JlYWRvbmx5ID0gcmVhZG9ubHk7XG4gICAgICB0aGlzLl9jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfaGlkZVNhdmVCdXR0b246IGJvb2xlYW47XG4gIGdldCBoaWRlU2F2ZUJ1dHRvbigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5faGlkZVNhdmVCdXR0b247XG4gIH1cbiAgQElucHV0KClcbiAgc2V0IGhpZGVTYXZlQnV0dG9uKGhpZGVTYXZlQnV0dG9uOiBib29sZWFuKSB7XG4gICAgaGlkZVNhdmVCdXR0b24gPSBjb2VyY2VCb29sZWFuUHJvcGVydHkoaGlkZVNhdmVCdXR0b24pO1xuICAgIGlmIChoaWRlU2F2ZUJ1dHRvbiAhPT0gdGhpcy5faGlkZVNhdmVCdXR0b24pIHtcbiAgICAgIHRoaXMuX2hpZGVTYXZlQnV0dG9uID0gaGlkZVNhdmVCdXR0b247XG4gICAgICB0aGlzLl9jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfY2FuU2F2ZTogYm9vbGVhbjtcbiAgZ2V0IGNhblNhdmUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2NhblNhdmU7XG4gIH1cbiAgQElucHV0KClcbiAgc2V0IGNhblNhdmUoY2FuU2F2ZTogYm9vbGVhbikge1xuICAgIGNhblNhdmUgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkoY2FuU2F2ZSk7XG4gICAgaWYgKGNhblNhdmUgIT09IHRoaXMuX2NhblNhdmUpIHtcbiAgICAgIHRoaXMuX2NhblNhdmUgPSBjYW5TYXZlO1xuICAgICAgdGhpcy5fY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3Bvc3RTYXZlSG9vazogKG9iajogVCkgPT4gT2JzZXJ2YWJsZTxUPjtcbiAgQElucHV0KClcbiAgc2V0IHBvc3RTYXZlSG9vayhwb3N0U2F2ZUhvb2s6IChvYmo6IFQpID0+IE9ic2VydmFibGU8VD4pIHtcbiAgICB0aGlzLl9wb3N0U2F2ZUhvb2sgPSBwb3N0U2F2ZUhvb2s7XG4gIH1cblxuICByZWFkb25seSBmb3JtOiBPYnNlcnZhYmxlPEZvcm1Hcm91cD47XG5cbiAgcHJpdmF0ZSBfbG9hZGluZzogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSk7XG4gIHJlYWRvbmx5IGxvYWRpbmc6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSB0aGlzLl9sb2FkaW5nIGFzIE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgcHJpdmF0ZSBfdXBkYXRlRm9ybUV2dDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBwcml2YXRlIF9zYXZlRXZ0OiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgcHJpdmF0ZSBfc2F2ZVN1YjogU3Vic2NyaXB0aW9uID0gU3Vic2NyaXB0aW9uLkVNUFRZO1xuXG4gIHByaXZhdGUgX3ZhbHVlQ2hhbmdlcyQ6IE9ic2VydmFibGU8YW55PjtcblxuICBAT3V0cHV0KClcbiAgZ2V0IHZhbHVlQ2hhbmdlcyQoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5fdmFsdWVDaGFuZ2VzJDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsIHByaXZhdGUgX2ZiOiBGb3JtQnVpbGRlciwgcHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXIpIHtcbiAgICB0aGlzLl9wcm9jZXNzRm9ybURhdGEgPSB0aGlzLl9kZWZhdWx0UHJvY2Vzc0RhdGE7XG5cbiAgICBjb25zdCBvYmpPYnMgPSBjb21iaW5lTGF0ZXN0KHRoaXMuX3NlcnZpY2UsIHRoaXMuX2lkKVxuICAgICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcigoW3MsIGldKSA9PiBzICE9IG51bGwgJiYgaSAhPSBudWxsKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcCgoW3MsIGldKSA9PiBbcywgaV0gYXMgW01vZGVsU2VydmljZTxULCBTLCBBPiwgbnVtYmVyIHwgJ25ldyddKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoW3MsIGldKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAnbmV3Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYnNPZih7fSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHMuZ2V0KGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXIobyA9PiBvICE9IG51bGwpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKG8gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcHJvY2Vzc09iamVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wcm9jZXNzT2JqZWN0IGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2Nlc3NPYmplY3QucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXAocG8gPT4gcG8obykpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcFRvKG8pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcHJvY2Vzc09iamVjdChvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ic09mKG8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZVJlcGxheSgxKSxcbiAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgIHRoaXMuZm9ybSA9IGNvbWJpbmVMYXRlc3Qob2JqT2JzLCB0aGlzLl91cGRhdGVGb3JtRXZ0KVxuICAgICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcChyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbW9kZWwgPSByWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZmIuZ3JvdXAoKHRoaXMuX2ZpZWxkcyB8fCBbXSkucmVkdWNlKChwcmV2LCBjdXIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBtb2RlbCA/IChtb2RlbCBhcyBhbnkpW2N1ci5uYW1lXSA6IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHByZXYgYXMgYW55KVtjdXIubmFtZV0gPSBbdmFsLCBjdXIudmFsaWRhdG9yc107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHt9KSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlUmVwbGF5KDEpKTtcblxuICAgIHRoaXMuX3ZhbHVlQ2hhbmdlcyQgPSB0aGlzLmZvcm0ucGlwZShzd2l0Y2hNYXAoKGZvcm0pID0+IGZvcm0udmFsdWVDaGFuZ2VzKSk7XG5cbiAgICBjb25zdCBzZXJ2aWNlT2JzID0gdGhpcy5fc2VydmljZS5waXBlKGZpbHRlcihzID0+IHMgIT0gbnVsbCkpO1xuXG4gICAgdGhpcy5fc2F2ZVN1YiA9XG4gICAgICAgIHRoaXMuX3NhdmVFdnRcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIHdpdGhMYXRlc3RGcm9tKHRoaXMuZm9ybSwgc2VydmljZU9icywgdGhpcy5faWQpLFxuICAgICAgICAgICAgICAgIG1hcChyID0+IHIuc2xpY2UoMSkgYXMgW0Zvcm1Hcm91cCwgTW9kZWxTZXJ2aWNlPFQsIFMsIEE+LCBudW1iZXIgfCAnbmV3J10pLFxuICAgICAgICAgICAgICAgIGZpbHRlcigoW2Zvcm0sIHNlcnZpY2UsIF9pZF0pID0+IGZvcm0gIT0gbnVsbCAmJiBzZXJ2aWNlICE9IG51bGwgJiYgZm9ybS52YWxpZCksXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChbZm9ybSwgc2VydmljZSwgaWRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBmb3JtVmFsdWUgPSB7Li4uZm9ybS52YWx1ZX07XG4gICAgICAgICAgICAgICAgICB0aGlzLl9kZWZhdWx0UHJvY2Vzc0RhdGEoZm9ybVZhbHVlKTtcbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wcm9jZXNzRm9ybURhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3Byb2Nlc3NGb3JtRGF0YSBpbnN0YW5jZW9mIE9ic2VydmFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc0Zvcm1EYXRhLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRhcChwZCA9PiBwZChmb3JtVmFsdWUpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVG8oW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1WYWx1ZSwgc2VydmljZSwgaWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgXSBhcyBbYW55LCBNb2RlbFNlcnZpY2U8VCwgUywgQT4sIG51bWJlciB8ICduZXcnXSksXG4gICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcm9jZXNzRm9ybURhdGEoZm9ybVZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ic09mPFthbnksIE1vZGVsU2VydmljZTxULCBTLCBBPiwgbnVtYmVyIHwgJ25ldyddPihcbiAgICAgICAgICAgICAgICAgICAgICBbZm9ybVZhbHVlLCBzZXJ2aWNlLCBpZF0pO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIHRhcChyID0+IHRoaXMuX2xvYWRpbmcubmV4dCh0cnVlKSksXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKHIgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgW2Zvcm1WYWx1ZSwgc2VydmljZSwgaWRdID1cbiAgICAgICAgICAgICAgICAgICAgICByIGFzIFthbnksIE1vZGVsU2VydmljZTxULCBTLCBBPiwgbnVtYmVyIHwgJ25ldyddO1xuICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSAnbmV3Jykge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgZm9ybVZhbHVlWydpZCddO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZSEuY3JlYXRlKGZvcm1WYWx1ZSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXR1cm4gc2VydmljZSEucGF0Y2goZm9ybVZhbHVlKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBtYXAob2JqID0+IG9iaiBhcyBUKSxcbiAgICAgICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcChyID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wb3N0U2F2ZUhvb2sgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JzT2Yocik7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcG9zdFNhdmVIb29rKHIpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgdGhpcy5fbG9hZGluZy5uZXh0KGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuZ29CYWNrKCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoKSA9PiB0aGlzLl9sb2FkaW5nLm5leHQoZmFsc2UpLFxuICAgICAgICAgICAgKTtcbiAgfVxuXG4gIGdvQmFjaygpOiB2b2lkIHtcbiAgICB0aGlzLl9yb3V0ZXIubmF2aWdhdGUoW3RoaXMuX2xpc3RVcmxdKTtcbiAgfVxuXG4gIHNhdmUoKTogdm9pZCB7XG4gICAgdGhpcy5fc2F2ZUV2dC5lbWl0KCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl91cGRhdGVGb3JtRXZ0LmNvbXBsZXRlKCk7XG4gICAgdGhpcy5fc2F2ZUV2dC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuX3NhdmVTdWIudW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2RlZmF1bHRQcm9jZXNzRGF0YSh2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5fZmllbGRzLmZvckVhY2goKGZpZWxkOiBBZG1pbkVkaXRGaWVsZCkgPT4ge1xuICAgICAgaWYgKGZpZWxkLnN1YnR5cGUpIHtcbiAgICAgICAgc3dpdGNoIChmaWVsZC5zdWJ0eXBlKSB7XG4gICAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICAgIGlmICh2YWx1ZVtmaWVsZC5uYW1lXSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZVtmaWVsZC5uYW1lXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgaWYgKHZhbHVlW2ZpZWxkLm5hbWVdLmluY2x1ZGVzKCcuJykpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZVtmaWVsZC5uYW1lXSA9IHBhcnNlRmxvYXQodmFsdWVbZmllbGQubmFtZV0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlW2ZpZWxkLm5hbWVdID0gcGFyc2VJbnQodmFsdWVbZmllbGQubmFtZV0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlRm9ybSgpOiB2b2lkIHtcbiAgICB0aGlzLl91cGRhdGVGb3JtRXZ0LmVtaXQoKTtcbiAgfVxufVxuIl19