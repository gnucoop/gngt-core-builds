/**
 * @license
 * Copyright (C) Gnucoop soc. coop.
 *
 * This file is part of the Gnucoop Angular Toolkit (gngt).
 *
 * Gnucoop Angular Toolkit (gngt) is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Gnucoop Angular Toolkit (gngt) is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Gnucoop Angular Toolkit (gngt).  If not, see http://www.gnu.org/licenses/.
 *
 */
import { HttpResponse } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { throwError } from 'rxjs';
import { catchError, map } from 'rxjs/operators';
import { SYNC_REGISTERED_MODELS } from './registered-models';
import { SyncService } from './sync-service';
export class OfflineInterceptor {
    constructor(_syncService) {
        this._syncService = _syncService;
    }
    intercept(req, next) {
        return next.handle(req).pipe(catchError((e) => {
            if (e.status === 0) {
                const models = this._checkOfflineRequest(req);
                if (models.length > 0) {
                    return this._doOfflineRequest(req, models[0], e);
                }
            }
            return throwError(e);
        }));
    }
    _doOfflineRequest(req, model, reqError) {
        const method = req.method.toLowerCase();
        const { exactMatch, relativeUrl } = this._analyzeRequestUrl(req, model);
        if (exactMatch) {
            if (method === 'get') {
                const limit = req.params.get('limit');
                const start = req.params.get('start');
                const sort = req.params.get('sort');
                const fields = req.params.get('fields');
                const joins = req.params.get('joins');
                return this._syncService.list(model.tableName, { limit, start, sort, fields, joins })
                    .pipe(catchError(_ => throwError(reqError)), map(res => new HttpResponse({ status: 200, statusText: 'OK', url: req.url, body: res })));
            }
            else if (method === 'post') {
                const obj = req.body;
                return this._syncService.create(model.tableName, obj)
                    .pipe(catchError(_ => throwError(reqError)), map(res => new HttpResponse({ status: 201, statusText: 'OK', url: req.url, body: res })));
            }
        }
        else {
            if (relativeUrl.length === 1) {
                const lastUrlPart = relativeUrl[0];
                if (lastUrlPart === 'delete_all') {
                    const ids = req.body.ids;
                    if (ids != null && ids instanceof Array && ids.length > 0) {
                        return this._syncService.deleteAll(model.tableName, ids)
                            .pipe(catchError(_ => throwError(reqError)), map(res => new HttpResponse({ status: 200, statusText: 'OK', url: req.url, body: res })));
                    }
                }
                else if (lastUrlPart === 'query') {
                    const params = req.body;
                    return this._syncService.query(model.tableName, params)
                        .pipe(catchError(_ => throwError(reqError)), map(res => new HttpResponse({ status: 200, statusText: 'OK', url: req.url, body: res })));
                }
                else {
                    const id = parseInt(lastUrlPart, 10);
                    if (!isNaN(id) && id > 0) {
                        let op = null;
                        let successStatus = 200;
                        const obj = req.body;
                        if (method === 'get') {
                            op = this._syncService.get(model.tableName, { id });
                            successStatus = 201;
                        }
                        else if (method === 'patch' || method === 'put') {
                            op = this._syncService.update(model.tableName, id, obj);
                        }
                        else if (method === 'delete') {
                            op = this._syncService.delete(model.tableName, id);
                        }
                        if (op != null) {
                            return op.pipe(catchError(_ => throwError(reqError)), map(res => new HttpResponse({ status: successStatus, statusText: 'OK', url: req.url, body: res })));
                        }
                    }
                }
            }
        }
        return throwError(reqError);
    }
    _analyzeRequestUrl(req, model) {
        const exactMatch = new RegExp('^' + model.endpoint + '$').test(req.url);
        if (exactMatch) {
            return { exactMatch, relativeUrl: [] };
        }
        const baseUrlParts = model.endpoint.split(/\/+/);
        const reqUrlParts = req.url.split(/\/+/);
        return { exactMatch, relativeUrl: reqUrlParts.slice(baseUrlParts.length) };
    }
    _checkOfflineRequest(req) {
        const urlParts = req.url.split('?');
        const urlPaths = urlParts[0].split('/');
        const urlPathsLen = urlPaths.length;
        let lastUrlPathIdx = urlPathsLen - 1;
        if (urlPaths[lastUrlPathIdx] === '') {
            lastUrlPathIdx -= 1;
        }
        const lastUrlPath = urlPaths[lastUrlPathIdx];
        const intVal = parseInt(lastUrlPath, 10);
        if (lastUrlPath === 'query' || (!isNaN(intVal) && `${intVal}` === lastUrlPath)) {
            urlPaths.splice(lastUrlPathIdx, 1);
        }
        const url = urlPaths.join('/');
        return SYNC_REGISTERED_MODELS.filter(m => m.endpoint === url);
    }
}
OfflineInterceptor.decorators = [
    { type: Injectable }
];
OfflineInterceptor.ctorParameters = () => [
    { type: SyncService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2ZmbGluZS1pbnRlcmNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3N5bmMvb2ZmbGluZS1pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUVILE9BQU8sRUFNTCxZQUFZLEVBQ2IsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBYSxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDNUMsT0FBTyxFQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUcvQyxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUMzRCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFHM0MsTUFBTSxPQUFPLGtCQUFrQjtJQUM3QixZQUFvQixZQUF5QjtRQUF6QixpQkFBWSxHQUFaLFlBQVksQ0FBYTtJQUFHLENBQUM7SUFFakQsU0FBUyxDQUFDLEdBQXFCLEVBQUUsSUFBaUI7UUFDaEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FDakIsVUFBVSxDQUFDLENBQUMsQ0FBb0IsRUFBRSxFQUFFO1lBQ2xDLElBQUksQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ2xCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDckIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDbEQ7YUFDRjtZQUNELE9BQU8sVUFBVSxD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QU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDaEUsQ0FBQzs7O1lBckhGLFVBQVU7OztZQUZILFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKEMpIEdudWNvb3Agc29jLiBjb29wLlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBHbnVjb29wIEFuZ3VsYXIgVG9vbGtpdCAoZ25ndCkuXG4gKlxuICogR251Y29vcCBBbmd1bGFyIFRvb2xraXQgKGduZ3QpIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBHbnVjb29wIEFuZ3VsYXIgVG9vbGtpdCAoZ25ndCkgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIEdudWNvb3AgQW5ndWxhciBUb29sa2l0IChnbmd0KS4gIElmIG5vdCwgc2VlIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8uXG4gKlxuICovXG5cbmltcG9ydCB7XG4gIEh0dHBFcnJvclJlc3BvbnNlLFxuICBIdHRwRXZlbnQsXG4gIEh0dHBIYW5kbGVyLFxuICBIdHRwSW50ZXJjZXB0b3IsXG4gIEh0dHBSZXF1ZXN0LFxuICBIdHRwUmVzcG9uc2Vcbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2NhdGNoRXJyb3IsIG1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1JlZ2lzdGVyZWRNb2RlbH0gZnJvbSAnLi9yZWdpc3RlcmVkLW1vZGVsJztcbmltcG9ydCB7U1lOQ19SRUdJU1RFUkVEX01PREVMU30gZnJvbSAnLi9yZWdpc3RlcmVkLW1vZGVscyc7XG5pbXBvcnQge1N5bmNTZXJ2aWNlfSBmcm9tICcuL3N5bmMtc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBPZmZsaW5lSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9zeW5jU2VydmljZTogU3luY1NlcnZpY2UpIHt9XG5cbiAgaW50ZXJjZXB0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgcmV0dXJuIG5leHQuaGFuZGxlKHJlcSkucGlwZShcbiAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGU6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgIGlmIChlLnN0YXR1cyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZGVscyA9IHRoaXMuX2NoZWNrT2ZmbGluZVJlcXVlc3QocmVxKTtcbiAgICAgICAgICAgICAgICAgICBpZiAobW9kZWxzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9kb09mZmxpbmVSZXF1ZXN0KHJlcSwgbW9kZWxzWzBdLCBlKTtcbiAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZSk7XG4gICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICkgYXMgT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj47XG4gIH1cblxuICBwcml2YXRlIF9kb09mZmxpbmVSZXF1ZXN0KFxuICAgICAgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBtb2RlbDogUmVnaXN0ZXJlZE1vZGVsLFxuICAgICAgcmVxRXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGNvbnN0IG1ldGhvZCA9IHJlcS5tZXRob2QudG9Mb3dlckNhc2UoKTtcbiAgICBjb25zdCB7ZXhhY3RNYXRjaCwgcmVsYXRpdmVVcmx9ID0gdGhpcy5fYW5hbHl6ZVJlcXVlc3RVcmwocmVxLCBtb2RlbCk7XG4gICAgaWYgKGV4YWN0TWF0Y2gpIHtcbiAgICAgIGlmIChtZXRob2QgPT09ICdnZXQnKSB7XG4gICAgICAgIGNvbnN0IGxpbWl0ID0gPGFueT5yZXEucGFyYW1zLmdldCgnbGltaXQnKTtcbiAgICAgICAgY29uc3Qgc3RhcnQgPSA8YW55PnJlcS5wYXJhbXMuZ2V0KCdzdGFydCcpO1xuICAgICAgICBjb25zdCBzb3J0ID0gPGFueT5yZXEucGFyYW1zLmdldCgnc29ydCcpO1xuICAgICAgICBjb25zdCBmaWVsZHMgPSA8YW55PnJlcS5wYXJhbXMuZ2V0KCdmaWVsZHMnKTtcbiAgICAgICAgY29uc3Qgam9pbnMgPSA8YW55PnJlcS5wYXJhbXMuZ2V0KCdqb2lucycpO1xuICAgICAgICByZXR1cm4gdGhpcy5fc3luY1NlcnZpY2UubGlzdChtb2RlbC50YWJsZU5hbWUsIHtsaW1pdCwgc3RhcnQsIHNvcnQsIGZpZWxkcywgam9pbnN9KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgY2F0Y2hFcnJvcihfID0+IHRocm93RXJyb3IocmVxRXJyb3IpKSxcbiAgICAgICAgICAgICAgICBtYXAocmVzID0+XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgSHR0cFJlc3BvbnNlKHtzdGF0dXM6IDIwMCwgc3RhdHVzVGV4dDogJ09LJywgdXJsOiByZXEudXJsLCBib2R5OiByZXN9KSksXG4gICAgICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdwb3N0Jykge1xuICAgICAgICBjb25zdCBvYmogPSByZXEuYm9keTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N5bmNTZXJ2aWNlLmNyZWF0ZShtb2RlbC50YWJsZU5hbWUsIG9iailcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoXyA9PiB0aHJvd0Vycm9yKHJlcUVycm9yKSksXG4gICAgICAgICAgICAgICAgbWFwKHJlcyA9PiBuZXcgSHR0cFJlc3BvbnNlKFxuICAgICAgICAgICAgICAgICAgICAgICAge3N0YXR1czogMjAxLCBzdGF0dXNUZXh0OiAnT0snLCB1cmw6IHJlcS51cmwsIGJvZHk6IHJlc30pKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZWxhdGl2ZVVybC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgY29uc3QgbGFzdFVybFBhcnQgPSByZWxhdGl2ZVVybFswXTtcbiAgICAgICAgaWYgKGxhc3RVcmxQYXJ0ID09PSAnZGVsZXRlX2FsbCcpIHtcbiAgICAgICAgICBjb25zdCBpZHMgPSByZXEuYm9keS5pZHM7XG4gICAgICAgICAgaWYgKGlkcyAhPSBudWxsICYmIGlkcyBpbnN0YW5jZW9mIEFycmF5ICYmIGlkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc3luY1NlcnZpY2UuZGVsZXRlQWxsKG1vZGVsLnRhYmxlTmFtZSwgaWRzKVxuICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKF8gPT4gdGhyb3dFcnJvcihyZXFFcnJvcikpLFxuICAgICAgICAgICAgICAgICAgICBtYXAocmVzID0+IG5ldyBIdHRwUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge3N0YXR1czogMjAwLCBzdGF0dXNUZXh0OiAnT0snLCB1cmw6IHJlcS51cmwsIGJvZHk6IHJlc30pKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGxhc3RVcmxQYXJ0ID09PSAncXVlcnknKSB7XG4gICAgICAgICAgY29uc3QgcGFyYW1zID0gcmVxLmJvZHk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX3N5bmNTZXJ2aWNlLnF1ZXJ5KG1vZGVsLnRhYmxlTmFtZSwgcGFyYW1zKVxuICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoXyA9PiB0aHJvd0Vycm9yKHJlcUVycm9yKSksXG4gICAgICAgICAgICAgICAgICBtYXAocmVzID0+IG5ldyBIdHRwUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHtzdGF0dXM6IDIwMCwgc3RhdHVzVGV4dDogJ09LJywgdXJsOiByZXEudXJsLCBib2R5OiByZXN9KSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGlkID0gcGFyc2VJbnQobGFzdFVybFBhcnQsIDEwKTtcbiAgICAgICAgICBpZiAoIWlzTmFOKGlkKSAmJiBpZCA+IDApIHtcbiAgICAgICAgICAgIGxldCBvcDogT2JzZXJ2YWJsZTxhbnk+fG51bGwgPSBudWxsO1xuICAgICAgICAgICAgbGV0IHN1Y2Nlc3NTdGF0dXM6IG51bWJlciA9IDIwMDtcbiAgICAgICAgICAgIGNvbnN0IG9iaiA9IHJlcS5ib2R5O1xuICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gJ2dldCcpIHtcbiAgICAgICAgICAgICAgb3AgPSB0aGlzLl9zeW5jU2VydmljZS5nZXQobW9kZWwudGFibGVOYW1lLCB7aWR9KTtcbiAgICAgICAgICAgICAgc3VjY2Vzc1N0YXR1cyA9IDIwMTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAncGF0Y2gnIHx8IG1ldGhvZCA9PT0gJ3B1dCcpIHtcbiAgICAgICAgICAgICAgb3AgPSB0aGlzLl9zeW5jU2VydmljZS51cGRhdGUobW9kZWwudGFibGVOYW1lLCBpZCwgb2JqKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnZGVsZXRlJykge1xuICAgICAgICAgICAgICBvcCA9IHRoaXMuX3N5bmNTZXJ2aWNlLmRlbGV0ZShtb2RlbC50YWJsZU5hbWUsIGlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvcCAhPSBudWxsKSB7XG4gICAgICAgICAgICAgIHJldHVybiBvcC5waXBlKFxuICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcihfID0+IHRocm93RXJyb3IocmVxRXJyb3IpKSxcbiAgICAgICAgICAgICAgICAgIG1hcChyZXMgPT4gbmV3IEh0dHBSZXNwb25zZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAge3N0YXR1czogc3VjY2Vzc1N0YXR1cywgc3RhdHVzVGV4dDogJ09LJywgdXJsOiByZXEudXJsLCBib2R5OiByZXN9KSksXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKHJlcUVycm9yKTtcbiAgfVxuXG4gIHByaXZhdGUgX2FuYWx5emVSZXF1ZXN0VXJsKHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbW9kZWw6IFJlZ2lzdGVyZWRNb2RlbCk6XG4gICAgICB7ZXhhY3RNYXRjaDogYm9vbGVhbiwgcmVsYXRpdmVVcmw6IHN0cmluZ1tdfSB7XG4gICAgY29uc3QgZXhhY3RNYXRjaCA9IG5ldyBSZWdFeHAoJ14nICsgbW9kZWwuZW5kcG9pbnQgKyAnJCcpLnRlc3QocmVxLnVybCk7XG4gICAgaWYgKGV4YWN0TWF0Y2gpIHtcbiAgICAgIHJldHVybiB7ZXhhY3RNYXRjaCwgcmVsYXRpdmVVcmw6IFtdfTtcbiAgICB9XG4gICAgY29uc3QgYmFzZVVybFBhcnRzID0gbW9kZWwuZW5kcG9pbnQuc3BsaXQoL1xcLysvKTtcbiAgICBjb25zdCByZXFVcmxQYXJ0cyA9IHJlcS51cmwuc3BsaXQoL1xcLysvKTtcbiAgICByZXR1cm4ge2V4YWN0TWF0Y2gsIHJlbGF0aXZlVXJsOiByZXFVcmxQYXJ0cy5zbGljZShiYXNlVXJsUGFydHMubGVuZ3RoKX07XG4gIH1cblxuICBwcml2YXRlIF9jaGVja09mZmxpbmVSZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3Q8YW55Pik6IFJlZ2lzdGVyZWRNb2RlbFtdIHtcbiAgICBjb25zdCB1cmxQYXJ0cyA9IHJlcS51cmwuc3BsaXQoJz8nKTtcbiAgICBjb25zdCB1cmxQYXRocyA9IHVybFBhcnRzWzBdLnNwbGl0KCcvJyk7XG4gICAgY29uc3QgdXJsUGF0aHNMZW4gPSB1cmxQYXRocy5sZW5ndGg7XG4gICAgbGV0IGxhc3RVcmxQYXRoSWR4ID0gdXJsUGF0aHNMZW4gLSAxO1xuICAgIGlmICh1cmxQYXRoc1tsYXN0VXJsUGF0aElkeF0gPT09ICcnKSB7XG4gICAgICBsYXN0VXJsUGF0aElkeCAtPSAxO1xuICAgIH1cbiAgICBjb25zdCBsYXN0VXJsUGF0aCA9IHVybFBhdGhzW2xhc3RVcmxQYXRoSWR4XTtcbiAgICBjb25zdCBpbnRWYWwgPSBwYXJzZUludChsYXN0VXJsUGF0aCwgMTApO1xuICAgIGlmIChsYXN0VXJsUGF0aCA9PT0gJ3F1ZXJ5JyB8fCAoIWlzTmFOKGludFZhbCkgJiYgYCR7aW50VmFsfWAgPT09IGxhc3RVcmxQYXRoKSkge1xuICAgICAgdXJsUGF0aHMuc3BsaWNlKGxhc3RVcmxQYXRoSWR4LCAxKTtcbiAgICB9XG4gICAgY29uc3QgdXJsID0gdXJsUGF0aHMuam9pbignLycpO1xuICAgIHJldHVybiBTWU5DX1JFR0lTVEVSRURfTU9ERUxTLmZpbHRlcihtID0+IG0uZW5kcG9pbnQgPT09IHVybCk7XG4gIH1cbn1cbiJdfQ==